<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>NishuAbhyasi â€“ Bihar B.Ed CET</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&family=Noto+Sans:wght@400;500;600&display=swap" rel="stylesheet"/>

<!-- â•â•â• FIREBASE SDK â•â•â• -->
<script type="module">
import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, addDoc, collection,
         getDocs, deleteDoc, query, orderBy, limit, where }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
         signOut, onAuthStateChanged, updateProfile }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyB_7Yt-CWb35d6yo2KCeIC07tuJbhzeSXM",
  authDomain: "nishuabhyasi-v2.firebaseapp.com",
  projectId: "nishuabhyasi-v2",
  storageBucket: "nishuabhyasi-v2.firebasestorage.app",
  messagingSenderId: "1066433753039",
  appId: "1:1066433753039:web:c92827706c967cbaa6ecba",
  measurementId: "G-20RSGDJ324"
};

let app, db, auth;
try {
  app  = initializeApp(FIREBASE_CONFIG);
  db   = getFirestore(app);
  auth = getAuth(app);
  window._db = db;
  window._auth = auth;
  window._dbReady = true;
  window._fs   = { doc, getDoc, setDoc, addDoc, collection, getDocs, deleteDoc, query, orderBy, limit, where };
  window._fauth = { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile };
} catch(e) {
  window._dbReady = false;
  window._dbError = e.message;
}
window.dispatchEvent(new Event('dbready'));
</script>

<style>
/* â•â• RESET & VARS â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --sf:#FF6B00;--sf-lt:#FFF3E8;--sf-dk:#C94E00;
  --gn:#138808;--gn-lt:#E8F5E9;
  --bl:#0057A8;--bl-lt:#E3F0FF;--bl-dk:#003d7a;
  --nv:#0a1628;--pur:#A855F7;--amb:#F59E0B;
  --bg:#EEF1F8;--tx:#1A1A2E;--mt:#6B7280;--bd:#E2E8F0;
  --c-ans:#138808;--c-no:#EF4444;--c-mk:#A855F7;--c-mka:#F59E0B;--c-nv:#94A3B8;
  --sh:0 2px 16px rgba(0,0,0,.07);--sh2:0 8px 32px rgba(0,0,0,.13);
  --fh:'Baloo 2',cursive;--fb:'Noto Sans',sans-serif;
}
html,body{height:100%;font-family:var(--fb);background:var(--bg);color:var(--tx);overflow-x:hidden;-webkit-tap-highlight-color:transparent}

/* â•â• FIX: Screen visibility â€” only ONE screen shows at a time â•â• */
.screen{display:none !important;flex-direction:column;min-height:100vh;position:relative}
.screen.active{display:flex !important;flex-direction:column}

/* â•â• FIX: Test screen needs special height handling â•â• */
#test.active{height:100vh;height:100dvh;overflow:hidden;min-height:0}

@keyframes spin  {to{transform:rotate(360deg)}}
@keyframes pulse {0%,100%{opacity:.35}50%{opacity:1}}
@keyframes blink {0%,100%{opacity:1}50%{opacity:.2}}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* â•â• SPLASH â•â• */
#splash{position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;
  align-items:center;justify-content:center;color:#fff;overflow:hidden;
  background:linear-gradient(135deg,var(--bl) 0%,var(--bl-dk) 55%,#001d3d 100%)}
#splash::before{content:'';position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(ellipse at 25% 55%,rgba(255,107,0,.2),transparent 55%),
             radial-gradient(ellipse at 78% 18%,rgba(0,120,255,.3),transparent 50%)}
.sp-wh{font-size:80px;animation:spin 11s linear infinite;z-index:1;margin-bottom:14px;
  filter:drop-shadow(0 0 20px rgba(255,184,0,.4))}
.sp-br{font-family:var(--fh);font-size:40px;font-weight:800;z-index:1}
.sp-br em{color:#FFB800;font-style:normal}
.sp-su{font-size:13px;opacity:.5;margin-bottom:44px;z-index:1}
.sp-bw{width:220px;height:5px;background:rgba(255,255,255,.1);border-radius:5px;overflow:hidden;z-index:1}
.sp-bf{height:100%;background:linear-gradient(90deg,#FFB800,var(--sf));transition:width .25s ease}
.sp-mg{font-size:13px;opacity:.4;margin-top:14px;animation:pulse 1.5s infinite;z-index:1}

/* â•â• DB SETUP GUIDE â•â• */
#db-setup{position:fixed;inset:0;z-index:9998;background:linear-gradient(135deg,#0a0f1a,#0d2137);
  display:none;align-items:center;justify-content:center;padding:16px;color:#fff}
#db-setup.on{display:flex}
.dbs-card{background:#fff;color:var(--tx);border-radius:22px;max-width:580px;width:100%;
  padding:32px 28px;box-shadow:var(--sh2);animation:fadeUp .3s ease;max-height:96vh;overflow-y:auto}
.dbs-card h2{font-family:var(--fh);font-size:22px;font-weight:800;color:var(--nv);margin-bottom:6px}
.dbs-card p{font-size:13px;color:var(--mt);line-height:1.7;margin-bottom:14px}
.step-list{display:flex;flex-direction:column;gap:10px;margin-bottom:18px}
.step{display:flex;gap:10px;align-items:flex-start;font-size:13px;line-height:1.6}
.step-n{width:26px;height:26px;background:var(--bl);color:#fff;border-radius:50%;display:flex;
  align-items:center;justify-content:center;font-weight:800;font-size:12px;flex-shrink:0;margin-top:1px}
.step a{color:var(--bl);font-weight:700}
.dbs-hint{background:var(--bl-lt);border:1.5px solid var(--bl);border-radius:10px;
  padding:10px 12px;font-size:12px;line-height:1.65;margin-bottom:14px;color:var(--bl-dk)}
.btn-dbs{width:100%;padding:13px;background:linear-gradient(135deg,var(--bl),var(--bl-dk));
  color:#fff;border:none;border-radius:11px;font-family:var(--fh);font-size:16px;
  font-weight:700;cursor:pointer;transition:.2s}
.btn-dbs:hover{transform:translateY(-1px)}

/* â•â• COMMON â•â• */
.btn{padding:11px 18px;border:none;border-radius:10px;font-family:var(--fb);font-size:13px;
  font-weight:600;cursor:pointer;transition:.18s;display:inline-flex;align-items:center;gap:6px;
  white-space:nowrap;-webkit-tap-highlight-color:transparent}
.btn:active{transform:scale(.97)}
.b-prim{background:var(--gn);color:#fff}
.b-blue{background:var(--bl);color:#fff}
.b-mark{background:var(--pur);color:#fff}
.b-gray{background:#6B7280;color:#fff}
.b-out{background:#fff;color:var(--bl);border:2px solid var(--bl)}
.b-sub{background:linear-gradient(135deg,#EF4444,#DC2626);color:#fff;font-weight:700;font-size:14px;padding:11px 22px}
.b-danger{background:#EF4444;color:#fff}
.b-sf{background:linear-gradient(135deg,var(--sf),var(--sf-dk));color:#fff}
.ft{background:var(--nv);color:rgba(255,255,255,.38);text-align:center;padding:14px 20px;
  font-size:11.5px;line-height:2.1;border-radius:14px;width:100%;flex-shrink:0}
.ft-br{font-family:var(--fh);font-size:15px;font-weight:800;color:#fff;display:block;margin-bottom:1px}
.ft-br em{color:#FFB800;font-style:normal}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(8px);
  background:var(--nv);color:#fff;padding:11px 22px;border-radius:24px;font-size:13px;
  font-weight:600;z-index:9000;opacity:0;pointer-events:none;transition:all .28s;
  white-space:nowrap;max-width:92vw;text-align:center}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:600;
  align-items:center;justify-content:center;padding:16px}
.mo.on{display:flex}
.md{background:#fff;border-radius:18px;padding:28px;max-width:400px;width:100%;
  box-shadow:0 24px 50px rgba(0,0,0,.35);animation:fadeUp .25s ease}
.md h3{font-family:var(--fh);font-size:20px;font-weight:800;margin-bottom:8px;color:var(--bl)}
.md p{font-size:14px;color:var(--mt);line-height:1.65;margin-bottom:14px}
.md-st{background:var(--bg);border-radius:10px;padding:12px;margin-bottom:18px;
  display:grid;grid-template-columns:1fr 1fr;gap:10px}
.ms{font-size:13px;color:var(--mt)}.ms span{font-weight:800;color:var(--bl)}
.md-bt{display:flex;gap:10px}.md-bt .btn{flex:1;justify-content:center;padding:13px}

/* â•â• REFRESH GUARD â•â• */
#rg{position:fixed;inset:0;background:rgba(5,15,30,.96);display:none;
  align-items:center;justify-content:center;z-index:8000;padding:16px}
#rg.on{display:flex}
.rg-c{background:#fff;border-radius:22px;padding:32px 26px;max-width:440px;width:100%;
  text-align:center;box-shadow:0 24px 60px rgba(0,0,0,.5);animation:fadeUp .3s ease}
.rg-ic{font-size:46px;margin-bottom:8px}
.rg-ti{font-family:var(--fh);font-size:21px;font-weight:800;color:var(--bl);margin-bottom:6px}
.rg-de{font-size:14px;color:var(--mt);line-height:1.65;margin-bottom:20px}
.rg-sg{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
.rg-si{background:var(--bg);border-radius:10px;padding:11px 6px}
.rg-sv{font-family:var(--fh);font-size:22px;font-weight:800;color:var(--bl)}
.rg-sl{font-size:11px;color:var(--mt);margin-top:2px}
.rg-bt{display:flex;flex-direction:column;gap:10px}
.btn-rg{padding:13px;border:none;border-radius:10px;font-family:var(--fh);font-size:15px;font-weight:700;cursor:pointer;transition:.2s}
.btn-resume{background:var(--gn);color:#fff}
.btn-fresh{background:var(--bg);color:var(--mt);border:2px solid var(--bd)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN: AUTH (Sign In / Sign Up)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#auth{background:linear-gradient(135deg,var(--bl) 0%,var(--bl-dk) 55%,var(--sf) 100%);
  align-items:center;justify-content:center;padding:20px}
.auth-out{width:100%;max-width:430px;display:flex;flex-direction:column;align-items:center;gap:14px}
.auth-card{background:#fff;border-radius:22px;padding:32px 28px;width:100%;
  box-shadow:var(--sh2);animation:fadeUp .35s ease}
.auth-logo{font-family:var(--fh);font-size:26px;font-weight:800;color:var(--bl);text-align:center;margin-bottom:2px}
.auth-logo em{color:var(--sf);font-style:normal}
.auth-sub{font-size:12px;color:var(--mt);text-align:center;margin-bottom:20px}
.auth-tabs{display:grid;grid-template-columns:1fr 1fr;background:var(--bg);border-radius:12px;padding:4px;gap:4px;margin-bottom:22px}
.auth-tab{padding:10px;border:none;border-radius:9px;font-family:var(--fh);font-size:14px;
  font-weight:700;cursor:pointer;transition:.2s;background:transparent;color:var(--mt)}
.auth-tab.on{background:#fff;color:var(--bl);box-shadow:0 2px 8px rgba(0,0,0,.1)}
.auth-panel{display:none}.auth-panel.on{display:block}
.fg{margin-bottom:14px}
.fg label{display:block;font-size:11px;font-weight:700;color:var(--mt);margin-bottom:5px;
  text-transform:uppercase;letter-spacing:.5px}
.fg input{width:100%;padding:13px 14px;border:2px solid var(--bd);border-radius:10px;
  font-family:var(--fb);font-size:15px;outline:none;transition:.2s;background:#fff;color:var(--tx)}
.fg input:focus{border-color:var(--bl);box-shadow:0 0 0 3px rgba(0,87,168,.08)}
.pw-row{position:relative}
.pw-row input{padding-right:44px}
.pw-eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;
  border:none;cursor:pointer;font-size:18px;color:var(--mt);padding:4px}
.auth-err{font-size:12px;color:#EF4444;min-height:18px;font-weight:600;margin-bottom:10px;text-align:center}
.btn-auth{width:100%;padding:14px;border:none;border-radius:11px;font-family:var(--fh);
  font-size:17px;font-weight:700;cursor:pointer;transition:.2s;margin-top:4px;color:#fff}
.btn-auth-si{background:linear-gradient(135deg,var(--bl),var(--bl-dk))}
.btn-auth-su{background:linear-gradient(135deg,var(--gn),#0f6b06)}
.btn-auth:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,0,0,.2)}
.btn-auth:disabled{opacity:.5;cursor:not-allowed;transform:none}
.auth-divider{display:flex;align-items:center;gap:10px;margin:18px 0}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--bd)}
.auth-divider span{font-size:12px;color:var(--mt);white-space:nowrap}
.btn-guest{width:100%;padding:12px;background:#fff;border:2px solid var(--bd);border-radius:11px;
  font-family:var(--fh);font-size:15px;font-weight:700;cursor:pointer;transition:.2s;color:var(--mt)}
.btn-guest:hover{background:var(--bg);border-color:var(--mt)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN: LANDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#landing{background:linear-gradient(135deg,var(--bl) 0%,var(--bl-dk) 55%,var(--sf) 100%);
  align-items:center;justify-content:center;padding:20px}
.lc-out{width:100%;max-width:520px;display:flex;flex-direction:column;align-items:center;gap:14px}
.lc{background:#fff;border-radius:22px;padding:28px 24px;width:100%;box-shadow:var(--sh2);animation:fadeUp .4s ease}
.lc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px}
.lc-br{font-family:var(--fh);font-size:24px;font-weight:800;color:var(--bl)}
.lc-br em{color:var(--sf);font-style:normal}
.user-badge{display:flex;align-items:center;gap:8px}
.ub-av{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--bl),var(--sf));
  color:#fff;display:flex;align-items:center;justify-content:center;font-family:var(--fh);font-size:15px;font-weight:800;flex-shrink:0}
.ub-inf{display:flex;flex-direction:column}
.ub-nm{font-size:13px;font-weight:700;color:var(--bl);line-height:1.2}
.ub-em{font-size:11px;color:var(--mt)}
.ub-out{font-size:12px;color:var(--c-no);cursor:pointer;font-weight:600;white-space:nowrap}
.ub-out:hover{text-decoration:underline}
.guest-badge{font-size:12px;color:var(--mt);background:var(--bg);padding:5px 12px;border-radius:20px;border:1px solid var(--bd)}
.guest-badge a{color:var(--bl);font-weight:700;cursor:pointer;text-decoration:none}
.ig{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:18px}
@media(max-width:400px){.ig{grid-template-columns:repeat(2,1fr)}}
.ib{background:var(--bg);border-radius:10px;padding:10px 6px;text-align:center}
.ib-v{font-family:var(--fh);font-size:22px;font-weight:800;color:var(--bl)}
.ib-l{font-size:10px;color:var(--mt);margin-top:2px}
.hdv{height:2px;background:linear-gradient(90deg,var(--sf),var(--bl));border-radius:2px;margin:14px 0}
.fg input:read-only{background:var(--bg);color:var(--mt)}
.no-q{display:none;background:#FFF3CD;border:1.5px solid #FFB800;border-radius:10px;
  padding:10px 12px;font-size:13px;color:#856404;margin-bottom:14px;line-height:1.6}
.no-q.on{display:block}
.hist-box{margin-bottom:18px}
.hist-title{font-size:12px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.hist-list{display:flex;flex-direction:column;gap:6px}
.hist-item{display:flex;align-items:center;background:var(--bg);border-radius:10px;padding:10px 12px;gap:10px;border:1px solid var(--bd)}
.hi-rank{font-family:var(--fh);font-size:18px;font-weight:800;min-width:26px;text-align:center}
.hi-info{flex:1;min-width:0}
.hi-date{font-size:11px;color:var(--mt)}
.hi-score{font-family:var(--fh);font-size:15px;font-weight:800;text-align:right}
.hi-pct{font-size:11px;color:var(--mt);text-align:right}
.lg-row{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:16px}
.ld{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--mt)}
.ld-d{width:12px;height:12px;border-radius:50%;flex-shrink:0}
.ib-box{background:var(--sf-lt);border:1.5px solid #FFB800;border-radius:10px;
  padding:12px;font-size:13px;line-height:1.75;margin-bottom:16px}
.ib-box strong{color:var(--sf-dk)}
.btn-st{width:100%;padding:15px;background:linear-gradient(135deg,var(--sf),var(--sf-dk));
  color:#fff;border:none;border-radius:12px;font-family:var(--fh);font-size:18px;
  font-weight:700;cursor:pointer;transition:.2s;letter-spacing:.3px}
.btn-st:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(255,107,0,.4)}
.btn-st:disabled{opacity:.4;cursor:not-allowed;transform:none}
.admin-link{margin-top:10px;font-size:12px;color:rgba(255,255,255,.45);cursor:pointer;text-align:center;transition:.2s}
.admin-link:hover{color:rgba(255,255,255,.85)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#admin-login{background:linear-gradient(135deg,var(--nv) 0%,#0d2137 100%);
  align-items:center;justify-content:center;padding:20px}
.al-card{background:#fff;border-radius:22px;padding:32px 28px;max-width:420px;width:100%;
  box-shadow:var(--sh2);text-align:center;animation:fadeUp .35s ease}
.al-icon{font-size:48px;margin-bottom:12px}
.al-title{font-family:var(--fh);font-size:24px;font-weight:800;color:var(--nv);margin-bottom:4px}
.al-sub{font-size:13px;color:var(--mt);margin-bottom:18px}
.al-badge{display:inline-block;background:linear-gradient(90deg,var(--bl),var(--bl-dk));
  color:#fff;font-size:11px;font-weight:700;padding:3px 14px;border-radius:20px;letter-spacing:.5px;margin-bottom:18px}
.setup-box{background:var(--gn-lt);border:1.5px solid var(--gn);border-radius:10px;
  padding:10px 12px;font-size:13px;color:#1b5e20;margin-bottom:14px;text-align:left;line-height:1.6;display:none}
.al-hint{background:var(--bl-lt);border-left:3px solid var(--bl);border-radius:0 8px 8px 0;
  padding:10px 12px;font-size:13px;color:var(--bl-dk);margin-bottom:16px;text-align:left;line-height:1.6}
.al-err{font-size:12px;color:#EF4444;min-height:16px;font-weight:600;margin-bottom:10px}
.btn-al{width:100%;padding:14px;background:linear-gradient(135deg,var(--nv),var(--bl-dk));
  color:#fff;border:none;border-radius:11px;font-family:var(--fh);font-size:17px;font-weight:700;cursor:pointer;transition:.2s;margin-top:4px}
.btn-al:hover{transform:translateY(-2px)}
.btn-al:disabled{opacity:.5;cursor:not-allowed;transform:none}
.al-back{margin-top:14px;font-size:13px;color:var(--mt);cursor:pointer;transition:.2s}
.al-back:hover{color:var(--bl)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#admin-panel{background:var(--bg)}
.ap-hdr{background:linear-gradient(90deg,var(--nv),var(--bl-dk));color:#fff;padding:0 20px;
  height:56px;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:100;box-shadow:0 3px 12px rgba(0,0,0,.3);flex-shrink:0}
.ap-logo{font-family:var(--fh);font-size:16px;font-weight:800}
.ap-logo em{color:#FFB800;font-style:normal}
.ap-logo span{opacity:.55;font-size:11px;font-weight:400;margin-left:6px}
.ap-hdr-rt{display:flex;align-items:center;gap:8px}
.ap-body{max-width:1200px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:20px}
.ap-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
@media(max-width:860px){.ap-grid{grid-template-columns:repeat(2,1fr)}}
.ap-stat{background:#fff;border-radius:14px;padding:18px;box-shadow:var(--sh);border-top:4px solid var(--bl)}
.ap-stat.g{border-top-color:var(--gn)}.ap-stat.o{border-top-color:var(--sf)}.ap-stat.p{border-top-color:var(--pur)}
.ap-sv{font-family:var(--fh);font-size:30px;font-weight:800;color:var(--tx)}
.ap-sl{font-size:11px;color:var(--mt);font-weight:600;margin-top:5px;text-transform:uppercase;letter-spacing:.4px}
.ap-card{background:#fff;border-radius:14px;padding:22px;box-shadow:var(--sh)}
.ap-card-hd{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px}
.ap-ct{font-family:var(--fh);font-size:17px;font-weight:800;color:var(--nv)}
.ap-cs{font-size:12px;color:var(--mt);margin-top:2px}
.last-upd{display:none;background:var(--gn-lt);border:1px solid var(--gn);border-radius:8px;
  padding:5px 10px;font-size:11px;font-weight:600;color:var(--gn);align-items:center;gap:5px}
.last-upd.on{display:inline-flex}
.q-status{display:flex;align-items:center;gap:14px;background:var(--bg);border-radius:10px;
  padding:12px 14px;margin-bottom:14px;flex-wrap:wrap;border:1px solid var(--bd)}
.qs-item{font-size:13px;color:var(--mt)}.qs-item b{color:var(--tx);font-weight:700}.qs-item.ok b{color:var(--gn)}
.q-area{width:100%;min-height:240px;max-height:360px;padding:12px;border:2px solid var(--bd);
  border-radius:10px;font-family:'Courier New',monospace;font-size:13px;line-height:1.6;
  outline:none;resize:vertical;transition:.2s;background:#FAFAFA;color:var(--tx)}
.q-area:focus{border-color:var(--bl);background:#fff}
.q-area.ok{border-color:var(--gn)}.q-area.bad{border-color:#EF4444}
.q-msg{font-size:12px;margin-top:5px;min-height:18px;font-weight:600}
.q-msg.ok{color:var(--gn)}.q-msg.bad{color:#EF4444}
.q-acts{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.tbl-bar{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.srch{padding:9px 12px;border:2px solid var(--bd);border-radius:9px;font-family:var(--fb);font-size:13px;outline:none;transition:.2s;flex:1;min-width:120px}
.srch:focus{border-color:var(--bl)}
.srt{padding:9px 10px;border:2px solid var(--bd);border-radius:9px;font-family:var(--fb);font-size:13px;outline:none;background:#fff;cursor:pointer}
.tbl-wrap{overflow-x:auto;border-radius:10px;border:1px solid var(--bd)}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:10px 10px;background:var(--bg);font-weight:700;font-size:11px;
  text-transform:uppercase;letter-spacing:.4px;color:var(--mt);border-bottom:2px solid var(--bd);white-space:nowrap}
td{padding:10px 10px;border-bottom:1px solid var(--bd);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:#f9fafb}
.sb{display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:700}
.sb-hi{background:#D1FAE5;color:#065F46}.sb-md{background:#FEF3C7;color:#92400E}.sb-lo{background:#FEE2E2;color:#991B1B}
.tbl-empty{text-align:center;padding:28px;color:var(--mt);font-size:14px}
.set-row{display:flex;align-items:center;justify-content:space-between;
  padding:14px 0;border-bottom:1px solid var(--bd);gap:14px}
.set-row:last-child{border-bottom:none}
.set-lbl{font-size:14px;font-weight:600;color:var(--tx);flex:1}
.set-dsc{font-size:12px;color:var(--mt);margin-top:2px}
.set-inp{padding:10px 12px;border:2px solid var(--bd);border-radius:8px;font-family:var(--fb);
  font-size:15px;outline:none;transition:.2s;width:70px;text-align:center;flex-shrink:0;
  -webkit-appearance:none;background:#fff;color:var(--tx)}
.set-inp:focus{border-color:var(--bl)}
.tog{width:46px;height:26px;background:var(--bd);border-radius:13px;cursor:pointer;
  position:relative;transition:.2s;border:none;flex-shrink:0;-webkit-tap-highlight-color:transparent}
.tog.on{background:var(--gn)}
.tog::after{content:'';position:absolute;width:20px;height:20px;background:#fff;
  border-radius:50%;top:3px;left:3px;transition:.2s;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.tog.on::after{left:23px}
.pw-change-row{display:flex;gap:8px;align-items:center;flex-shrink:0}
.pw-change-row input{padding:10px 12px;border:2px solid var(--bd);border-radius:8px;font-family:var(--fb);
  font-size:14px;outline:none;transition:.2s;width:150px;background:#fff;color:var(--tx)}
@media(max-width:480px){
  .set-row{flex-wrap:wrap}
  .pw-change-row{width:100%}
  .pw-change-row input{flex:1;width:auto}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TEST SCREEN â€” mobile-first fixes
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.th{background:linear-gradient(90deg,var(--bl),var(--bl-dk));color:#fff;padding:0 16px;
  height:56px;display:flex;align-items:center;justify-content:space-between;gap:10px;
  position:sticky;top:0;z-index:100;box-shadow:0 3px 12px rgba(0,0,0,.28);flex-shrink:0}
.th-logo{font-family:var(--fh);font-size:16px;font-weight:800;white-space:nowrap}
.th-logo em{color:#FFB800;font-style:normal}
.th-ctr{flex:1;display:flex;justify-content:center}
.tp{display:flex;align-items:center;gap:7px;background:rgba(255,255,255,.1);
  padding:6px 14px;border-radius:24px;border:1px solid rgba(255,255,255,.18)}
.tp-lbl{font-size:10px;opacity:.65;font-weight:700;letter-spacing:.6px}
.tp-v{font-family:var(--fh);font-size:19px;font-weight:800;letter-spacing:2px;min-width:86px;text-align:center}
.tp-v.warn{color:#FFB800;animation:blink .9s infinite}
.tp-v.danger{color:#FF4444;animation:blink .45s infinite}
.th-rt{display:flex;align-items:center;gap:8px;flex-shrink:0}
.th-cand{text-align:right}
.th-name{font-size:12px;font-weight:700}
.th-roll{font-size:10px;opacity:.6}
.btn-fs{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);
  color:#fff;font-size:15px;cursor:pointer;padding:5px 9px;border-radius:7px;transition:.2s}
.rv-ban{background:var(--pur);color:#fff;text-align:center;padding:7px;
  font-size:13px;font-weight:700;display:none;flex-shrink:0}
.rv-ban.on{display:block}
.pb-w{height:4px;background:rgba(0,87,168,.12);flex-shrink:0}
.pb{height:100%;background:linear-gradient(90deg,#FFB800,var(--sf));transition:width .35s;border-radius:0 3px 3px 0}
.st-wrap{display:flex;overflow-x:auto;background:#fff;border-bottom:2px solid var(--bd);
  scrollbar-width:none;padding:0 10px;flex-shrink:0;-webkit-overflow-scrolling:touch}
.st-wrap::-webkit-scrollbar{display:none}
.st{padding:11px 18px;font-size:13px;font-weight:600;cursor:pointer;
  border-bottom:3px solid transparent;white-space:nowrap;transition:.2s;
  color:var(--mt);flex-shrink:0;border-radius:6px 6px 0 0;margin-top:3px;
  -webkit-tap-highlight-color:transparent;min-height:44px;display:flex;align-items:center}
.st.on{color:var(--bl);border-bottom-color:var(--bl);background:var(--bl-lt)}
.st:hover:not(.on){color:var(--bl);background:#f4f8ff}

/* â•â• FIX: Remove conflicting height/overflow from #test base â€” handled by .active rule â•â• */
.tb{display:flex;flex:1;overflow:hidden;min-height:0}
.qp{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:16px;
  -webkit-overflow-scrolling:touch;min-width:0}
.qp::-webkit-scrollbar{width:4px}.qp::-webkit-scrollbar-thumb{background:var(--bd);border-radius:10px}
.q-meta{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
.q-badge{font-family:var(--fh);font-size:13px;font-weight:700;background:var(--bl);color:#fff;padding:4px 14px;border-radius:20px}
.q-marks{display:flex;gap:6px;align-items:center}
.mk-ok{font-size:11px;background:var(--gn-lt);color:var(--gn);font-weight:700;padding:3px 10px;border-radius:10px;border:1px solid var(--gn)}
.mk-no{font-size:11px;background:#fff0f0;color:var(--c-no);font-weight:700;padding:3px 10px;border-radius:10px;border:1px solid var(--c-no);display:none}
.mk-no.on{display:inline-block}
.qc{background:#fff;border-radius:16px;padding:20px;box-shadow:var(--sh);position:relative;overflow:hidden}
.qc::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--bl),var(--sf))}
.q-tx{font-size:16px;line-height:1.75;font-weight:500;margin-bottom:20px;color:var(--tx)}
.q-im{max-width:100%;border-radius:10px;margin-bottom:14px;border:1px solid var(--bd)}
.opts{display:flex;flex-direction:column;gap:10px}
@media(min-width:1100px){.opts{display:grid;grid-template-columns:1fr 1fr}}
.opt{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;border:2px solid var(--bd);
  border-radius:12px;cursor:pointer;transition:.18s;background:#fff;font-size:15px;
  text-align:left;width:100%;min-height:54px;-webkit-tap-highlight-color:transparent}
.opt:active{transform:scale(.98)}
.opt.sel{border-color:var(--bl);background:var(--bl-lt);box-shadow:0 0 0 1px var(--bl)}
.opt.cor{border-color:var(--gn);background:var(--gn-lt)!important;box-shadow:0 0 0 1px var(--gn)}
.opt.inc{border-color:var(--c-no);background:#fff0f0!important;box-shadow:0 0 0 1px var(--c-no)}
.opt-k{width:32px;height:32px;border-radius:50%;background:var(--bg);display:flex;
  align-items:center;justify-content:center;font-weight:800;font-size:13px;flex-shrink:0;
  transition:.18s;font-family:var(--fh);margin-top:1px}
.opt.sel .opt-k{background:var(--bl);color:#fff}
.opt.cor .opt-k{background:var(--gn);color:#fff}
.opt.inc .opt-k{background:var(--c-no);color:#fff}
.opt-tx{line-height:1.55;flex:1;padding-top:4px;font-size:15px}
.ab{display:flex;align-items:center;gap:6px;background:#fff;padding:10px 12px;
  border-top:2px solid var(--bd);flex-shrink:0;min-height:60px;
  padding-bottom:max(10px, env(safe-area-inset-bottom));
  box-shadow:0 -2px 8px rgba(0,0,0,.06)}
.ab-sp{flex:1}
.ab .btn{padding:11px 12px;font-size:13px;white-space:nowrap}
/* Sidebar */
.sidebar{width:290px;background:#fff;border-left:2px solid var(--bd);overflow-y:auto;display:flex;flex-direction:column;flex-shrink:0}
.sidebar::-webkit-scrollbar{width:4px}.sidebar::-webkit-scrollbar-thumb{background:var(--bd);border-radius:10px}
.sb-hd{padding:12px 14px;border-bottom:2px solid var(--bd);font-family:var(--fh);font-weight:800;font-size:14px;color:var(--bl);background:var(--bl-lt)}
.sb-ci{padding:10px 14px;background:linear-gradient(90deg,#e3f0ff,#fff);border-bottom:1px solid var(--bd)}
.sb-nm{font-weight:800;font-size:14px;color:var(--bl)}.sb-rl{font-size:11px;color:var(--mt);margin-top:1px}
.sg{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--bd)}
.sc{padding:10px 6px;text-align:center;border-right:1px solid var(--bd);border-bottom:1px solid var(--bd)}
.sc:nth-child(even){border-right:none}
.sv{font-family:var(--fh);font-size:20px;font-weight:800}
.sl{font-size:10px;color:var(--mt);margin-top:1px;font-weight:600}
.sv-a{color:var(--c-ans)}.sv-n{color:var(--c-no)}.sv-m{color:var(--pur)}.sv-ma{color:var(--amb)}
.qg-sec{padding:12px 14px}.qg-ttl{font-size:11px;font-weight:800;color:var(--mt);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
.qgrid{display:grid;grid-template-columns:repeat(6,1fr);gap:5px}
.qb{width:100%;aspect-ratio:1;border:none;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;transition:.15s;background:var(--c-nv);color:#fff;font-family:var(--fb)}
.qb.cur{outline:3px solid var(--bl);outline-offset:2px}
.qb.ans{background:var(--c-ans)}.qb.no{background:var(--c-no)}
.qb.mk{background:var(--pur)}.qb.mka{background:var(--amb)}
.sb-lg{padding:10px 14px;border-top:1px solid var(--bd);display:flex;flex-direction:column;gap:6px}
.sbl{display:flex;align-items:center;gap:7px;font-size:12px;color:var(--mt)}
.sbl-b{width:18px;height:18px;border-radius:4px;flex-shrink:0}
.sb-sub{padding:12px 14px;border-top:1px solid var(--bd);margin-top:auto}
.mob-tog{display:none;position:fixed;bottom:76px;right:14px;z-index:200;background:var(--bl);
  color:#fff;border:none;border-radius:50%;width:50px;height:50px;font-size:20px;cursor:pointer;
  box-shadow:0 4px 14px rgba(0,0,0,.35);align-items:center;justify-content:center}
.sb-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:150}
@media(max-width:1024px){
  .sidebar{position:fixed;right:-300px;top:0;bottom:0;z-index:160;transition:right .3s;box-shadow:-6px 0 20px rgba(0,0,0,.2)}
  .sidebar.open{right:0}.mob-tog{display:flex}.sb-ov.on{display:block}
}
@media(max-width:480px){
  .qp{padding:10px}.qc{padding:14px 12px}.q-tx{font-size:15px;margin-bottom:16px}
  .opts{gap:8px}
  .opt{padding:13px 12px;font-size:14px;border-radius:10px;gap:10px}
  .opt-tx{font-size:14px;line-height:1.5}
  .opt-k{width:30px;height:30px;font-size:12px;flex-shrink:0}
  .ab{gap:5px;padding:8px 10px;padding-bottom:max(8px,env(safe-area-inset-bottom));flex-wrap:nowrap}
  .ab .btn{padding:10px 8px;font-size:12px;min-width:0}
  .btn-mark-text{display:none}
  .st{padding:8px 12px;font-size:12px}.th-cand{display:none}
  .mob-tog{bottom:72px;right:12px;width:46px;height:46px;font-size:18px}
}
@media(max-width:360px){
  .ab .btn{padding:9px 6px;font-size:11px}
  .opt{padding:11px 10px}.opt-tx{font-size:13px}
}

/* â•â• RESULT SCREEN â•â• */
#result{background:linear-gradient(135deg,var(--bl),var(--bl-dk));align-items:center;justify-content:flex-start;padding:20px;overflow-y:auto}
.rc-out{display:flex;flex-direction:column;align-items:center;gap:14px;width:100%;max-width:640px;margin:0 auto}
.rc{background:#fff;border-radius:22px;width:100%;box-shadow:var(--sh2);overflow:hidden;animation:fadeUp .4s ease}
.rc-hd{background:linear-gradient(135deg,var(--sf),var(--sf-dk));padding:24px;text-align:center;color:#fff}
.rc-hd h2{font-family:var(--fh);font-size:24px;font-weight:800;margin-bottom:3px}
.rc-hd p{opacity:.85;font-size:14px}
.rc-sa{padding:22px 22px 0;display:flex;gap:22px;align-items:center;justify-content:center;flex-wrap:wrap}
.sr-w{width:140px;height:140px;position:relative;flex-shrink:0}
.sr-svg{width:140px;height:140px;transform:rotate(-90deg)}
.sr-bg{fill:none;stroke:#f0f0f0;stroke-width:12}
.sr-f{fill:none;stroke-width:12;stroke-linecap:round;transition:stroke-dashoffset 1.6s cubic-bezier(.4,0,.2,1)}
.sr-tx{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.sr-pct{font-family:var(--fh);font-size:32px;font-weight:800;color:var(--bl);line-height:1}
.sr-lb{font-size:11px;color:var(--mt);margin-top:2px}
.sd{display:flex;flex-direction:column;gap:8px}
.sd-tot{font-family:var(--fh);font-size:26px;font-weight:800;color:var(--tx)}
.sd-row{font-size:13px;color:var(--mt)}.sd-row b{color:var(--bl)}
.rc-st{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--bd);
  margin-top:18px;border-top:1px solid var(--bd);border-bottom:1px solid var(--bd)}
.rs{background:#fff;padding:16px 6px;text-align:center}
.rs .rv{font-family:var(--fh);font-size:22px;font-weight:800}
.rs .rl{font-size:11px;color:var(--mt);margin-top:2px;font-weight:600}
.rs-c .rv{color:var(--gn)}.rs-w .rv{color:var(--c-no)}.rs-s .rv{color:var(--mt)}
.rc-msg{padding:14px 22px;text-align:center;font-size:14px;font-weight:600;color:var(--mt);background:var(--bg)}
.rc-act{padding:20px;display:flex;gap:10px}
.rc-btn{flex:1;padding:13px;border:none;border-radius:11px;font-family:var(--fh);font-size:15px;font-weight:700;cursor:pointer;transition:.2s}
.rcb-rv{background:var(--bl);color:#fff}
.rcb-rs{background:var(--gn);color:#fff}
</style>
</head>
<body>

<!-- â•â•â• SPLASH â•â•â• -->
<div id="splash">
  <div class="sp-wh">â˜¸ï¸</div>
  <div class="sp-br">Nishu<em>Abhyasi</em></div>
  <div class="sp-su">Bihar B.Ed CET â€“ Online Mock Test Portal</div>
  <div class="sp-bw"><div class="sp-bf" id="sp-bf" style="width:0%"></div></div>
  <div class="sp-mg" id="sp-mg">Connecting to databaseâ€¦</div>
</div>

<!-- â•â•â• DB SETUP GUIDE â•â•â• -->
<div id="db-setup">
  <div class="dbs-card">
    <h2>ğŸ”§ Firebase Setup Required</h2>
    <p>Paste your Firebase config into <code>index.html</code> to connect the database. One-time, 5-minute setup.</p>
    <div class="step-list">
      <div class="step"><div class="step-n">1</div><div>Go to <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a> â†’ Add project â†’ "nishuabhyasi"</div></div>
      <div class="step"><div class="step-n">2</div><div><strong>Build â†’ Firestore Database â†’ Create database â†’ Test mode</strong> â†’ choose region</div></div>
      <div class="step"><div class="step-n">3</div><div><strong>Authentication â†’ Sign-in method â†’ Email/Password â†’ Enable</strong> (new step for student accounts)</div></div>
      <div class="step"><div class="step-n">4</div><div>Project Settings â†’ Your apps â†’ âŠ™ Web â†’ Register â†’ copy <code>firebaseConfig</code> object</div></div>
      <div class="step"><div class="step-n">5</div><div>Paste values into the <code>FIREBASE_CONFIG</code> block at top of index.html â†’ save â†’ re-upload</div></div>
    </div>
    <div class="dbs-hint">ğŸ’¡ Free tier: 50,000 reads + 20,000 writes/day. No credit card. Student accounts stored in Firebase Auth (free, unlimited).</div>
    <button class="btn-dbs" onclick="location.reload()">ğŸ”„ I've Updated the Config â€” Reload</button>
  </div>
</div>

<!-- â•â•â• REFRESH GUARD â•â•â• -->
<div id="rg">
  <div class="rg-c">
    <div class="rg-ic">âš ï¸</div>
    <div class="rg-ti">Test Was Interrupted</div>
    <div class="rg-de">Your answers are <strong>saved</strong>. Resume exactly where you left off.</div>
    <div class="rg-sg">
      <div class="rg-si"><div class="rg-sv" id="rg-ans">â€”</div><div class="rg-sl">Answered</div></div>
      <div class="rg-si"><div class="rg-sv" id="rg-tim">â€”</div><div class="rg-sl">Time Left</div></div>
      <div class="rg-si"><div class="rg-sv" id="rg-q">â€”</div><div class="rg-sl">Last Q.</div></div>
    </div>
    <div class="rg-bt">
      <button class="btn-rg btn-resume" onclick="doResume()">â–¶ Resume My Test</button>
      <button class="btn-rg btn-fresh" onclick="doFresh()">ğŸ—‘ Discard & Start Fresh</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• SCREEN: AUTH â•â•â•â•â•â•â• -->
<div id="auth" class="screen">
  <div class="auth-out">
    <div class="auth-card">
      <div class="auth-logo">Nishu<em>Abhyasi</em></div>
      <div class="auth-sub">Bihar B.Ed CET â€“ Mock Test Portal</div>
      <div class="auth-tabs">
        <button class="auth-tab on" id="tab-si" onclick="switchAuthTab('si')">Sign In</button>
        <button class="auth-tab" id="tab-su" onclick="switchAuthTab('su')">Register</button>
      </div>
      <!-- Sign In -->
      <div class="auth-panel on" id="panel-si">
        <div class="fg"><label>Email</label><input type="email" id="si-email" placeholder="your@email.com" autocomplete="email"/></div>
        <div class="fg"><label>Password</label>
          <div class="pw-row">
            <input type="password" id="si-pw" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doSignIn()"/>
            <button class="pw-eye" onclick="toggleEyeId('si-pw')">ğŸ‘</button>
          </div>
        </div>
        <div class="auth-err" id="si-err"></div>
        <button class="btn-auth btn-auth-si" id="si-btn" onclick="doSignIn()">â†’ Sign In</button>
        <div class="auth-divider"><span>or continue without account</span></div>
        <button class="btn-guest" onclick="goGuest()">ğŸ‘¤ Continue as Guest</button>
      </div>
      <!-- Register -->
      <div class="auth-panel" id="panel-su">
        <div class="fg"><label>Full Name</label><input type="text" id="su-name" placeholder="Your full name" autocomplete="name"/></div>
        <div class="fg"><label>Email</label><input type="email" id="su-email" placeholder="your@email.com" autocomplete="email"/></div>
        <div class="fg"><label>Password <span style="font-weight:400;text-transform:none">(min 6 chars)</span></label>
          <div class="pw-row">
            <input type="password" id="su-pw" placeholder="Create password" autocomplete="new-password"/>
            <button class="pw-eye" onclick="toggleEyeId('su-pw')">ğŸ‘</button>
          </div>
        </div>
        <div class="fg"><label>Confirm Password</label>
          <div class="pw-row">
            <input type="password" id="su-pw2" placeholder="Repeat password" autocomplete="new-password" onkeydown="if(event.key==='Enter')doSignUp()"/>
            <button class="pw-eye" onclick="toggleEyeId('su-pw2')">ğŸ‘</button>
          </div>
        </div>
        <div class="auth-err" id="su-err"></div>
        <button class="btn-auth btn-auth-su" id="su-btn" onclick="doSignUp()">âœ” Create Account</button>
        <div class="auth-divider"><span>or continue without account</span></div>
        <button class="btn-guest" onclick="goGuest()">ğŸ‘¤ Continue as Guest</button>
      </div>
    </div>
    <footer class="ft" style="max-width:430px">
      <span class="ft-br">Nishu<em>Abhyasi</em></span>
      An app by <strong style="color:#fff">Yashwant</strong> &nbsp;|&nbsp; Â© 2025
    </footer>
  </div>
</div>

<!-- â•â•â•â•â•â•â• SCREEN: LANDING â•â•â•â•â•â•â• -->
<div id="landing" class="screen">
  <div class="lc-out">
    <div class="lc">
      <!-- Top row: brand + user info -->
      <div class="lc-top">
        <div class="lc-br">Nishu<em>Abhyasi</em></div>
        <!-- Logged-in user badge -->
        <div class="user-badge" id="user-badge" style="display:none">
          <div class="ub-av" id="ub-av">Y</div>
          <div class="ub-inf">
            <div class="ub-nm" id="ub-name">Student</div>
            <div class="ub-em" id="ub-email">email</div>
          </div>
          <span class="ub-out" onclick="doSignOut()">Sign out</span>
        </div>
        <!-- Guest badge -->
        <div class="guest-badge" id="guest-badge" style="display:none">
          Guest &nbsp;|&nbsp; <a onclick="showScreen('auth')">Sign in</a>
        </div>
      </div>

      <!-- Stats row -->
      <div class="ig">
        <div class="ib"><div class="ib-v" id="info-tot">â€”</div><div class="ib-l">Questions</div></div>
        <div class="ib"><div class="ib-v" id="info-min">â€”</div><div class="ib-l">Duration (min)</div></div>
        <div class="ib"><div class="ib-v">+1</div><div class="ib-l">Per Correct</div></div>
        <div class="ib"><div class="ib-v" id="info-neg">0</div><div class="ib-l">Neg. Mark</div></div>
      </div>

      <div class="hdv"></div>

      <!-- No questions notice -->
      <div class="no-q" id="no-q">âš ï¸ <strong>No questions yet.</strong> Admin needs to upload questions before the test can begin.</div>

      <!-- Attempt History (logged-in only) -->
      <div id="hist-section" style="display:none">
        <div class="hist-box">
          <div class="hist-title">ğŸ“Š Your Last 5 Attempts</div>
          <div class="hist-list" id="hist-list">
            <div style="font-size:13px;color:var(--mt);padding:8px 0">No attempts yet. Take your first test!</div>
          </div>
        </div>
        <div class="hdv"></div>
      </div>

      <!-- Student name / roll / email fields -->
      <div class="fg" id="fg-name"><label>Your Full Name</label>
        <input type="text" id="c-name" placeholder="Enter your full name"/>
      </div>
      <div class="fg" id="fg-roll-or-email">
        <!-- For guests: optional email -->
        <div id="guest-fields">
          <label>Email (Optional â€” to receive results)</label>
          <input type="email" id="c-email" placeholder="your@email.com (optional)"/>
        </div>
        <!-- For logged-in users: show roll number field -->
        <div id="loggedin-fields" style="display:none">
          <label>Roll Number (Optional)</label>
          <input type="text" id="c-roll" placeholder="e.g. BED2025001"/>
        </div>
      </div>

      <div class="ib-box">
        <strong>ğŸ“‹ Instructions:</strong><br/>
        1. All questions are MCQ â€” one correct answer only.<br/>
        2. Each correct answer = <strong>+1 mark</strong>. Do not refresh.<br/>
        3. Mark questions for review and revisit them.<br/>
        4. Submit when done or when time expires.
      </div>
      <div class="lg-row">
        <div class="ld"><div class="ld-d" style="background:var(--c-ans)"></div>Answered</div>
        <div class="ld"><div class="ld-d" style="background:var(--c-no)"></div>Not Ans.</div>
        <div class="ld"><div class="ld-d" style="background:var(--pur)"></div>Marked</div>
        <div class="ld"><div class="ld-d" style="background:var(--amb)"></div>Marked+Ans</div>
        <div class="ld"><div class="ld-d" style="background:var(--c-nv)"></div>Not Visited</div>
      </div>
      <button class="btn-st" id="btn-st" onclick="startTest()">âœ… I Have Read Instructions â€” Start Test</button>
    </div>
    <div class="admin-link" onclick="goAdmin()">ğŸ” Admin Panel</div>
    <footer class="ft">
      <span class="ft-br">Nishu<em>Abhyasi</em></span>
      An app by <strong style="color:#fff">Yashwant</strong> &nbsp;|&nbsp; Â© 2025 &nbsp;|&nbsp; Bihar B.Ed CET Prep
    </footer>
  </div>
</div>

<!-- â•â•â•â•â•â•â• SCREEN: ADMIN LOGIN â•â•â•â•â•â•â• -->
<div id="admin-login" class="screen">
  <div style="background:linear-gradient(135deg,var(--nv),#0d2137);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;flex-direction:column;gap:14px">
    <div class="al-card">
      <div class="al-icon">ğŸ›¡ï¸</div>
      <div class="al-title">Admin Panel</div>
      <div class="al-sub">NishuAbhyasi â€” Secure Access</div>
      <div class="al-badge">ADMINISTRATOR ONLY</div>
      <div class="setup-box" id="setup-box">ğŸ”‘ <strong>First-time:</strong> Create your admin password now. Stored as SHA-256 hash.</div>
      <div class="al-hint" id="al-hint">Enter your admin password to continue.</div>
      <div style="position:relative;margin-bottom:6px">
        <input type="password" id="al-pw" placeholder="Admin password" style="width:100%;padding:13px 44px 13px 14px;border:2px solid var(--bd);border-radius:10px;font-family:var(--fb);font-size:16px;outline:none;transition:.2s;background:#fff;letter-spacing:2px" onkeydown="if(event.key==='Enter')doAdminLogin()"/>
        <button class="pw-eye" onclick="toggleEyeId('al-pw')">ğŸ‘</button>
      </div>
      <div class="al-err" id="al-err"></div>
      <button class="btn-al" id="al-btn" onclick="doAdminLogin()">ğŸ”“ Login to Admin Panel</button>
      <div class="al-back" onclick="showScreen('landing')">â† Back to Student Portal</div>
    </div>
    <footer class="ft" style="max-width:420px">
      <span class="ft-br">Nishu<em>Abhyasi</em></span>
      An app by <strong style="color:#fff">Yashwant</strong> &nbsp;|&nbsp; Â© 2025
    </footer>
  </div>
</div>

<!-- â•â•â•â•â•â•â• SCREEN: ADMIN PANEL â•â•â•â•â•â•â• -->
<div id="admin-panel" class="screen">
  <div class="ap-hdr">
    <div class="ap-logo">Nishu<em>Abhyasi</em> <span>Admin</span></div>
    <div class="ap-hdr-rt">
      <button class="btn b-out" style="font-size:12px;padding:6px 12px" onclick="showScreen('landing')">â† Portal</button>
      <button class="btn b-danger" style="font-size:12px;padding:6px 12px" onclick="adminOut()">Logout</button>
    </div>
  </div>
  <div class="ap-body">
    <!-- Stats -->
    <div class="ap-grid">
      <div class="ap-stat">  <div class="ap-sv" id="ap-nq">â€”</div><div class="ap-sl">ğŸ“ Questions</div></div>
      <div class="ap-stat g"><div class="ap-sv" id="ap-na">â€”</div><div class="ap-sl">ğŸ‘©â€ğŸ“ Attempts</div></div>
      <div class="ap-stat o"><div class="ap-sv" id="ap-av">â€”</div><div class="ap-sl">ğŸ“Š Avg Score</div></div>
      <div class="ap-stat p"><div class="ap-sv" id="ap-tp">â€”</div><div class="ap-sl">ğŸ† Top Score</div></div>
    </div>
    <!-- Questions -->
    <div class="ap-card">
      <div class="ap-card-hd">
        <div><div class="ap-ct">ğŸ“‹ Question Bank</div><div class="ap-cs">Paste JSON â†’ Save â†’ Live for all students instantly</div></div>
        <div class="last-upd" id="lu"><span>âœ… </span><span id="lu-t">â€”</span></div>
      </div>
      <div class="q-status">
        <div class="qs-item ok">Loaded: <b id="qs-n">0</b> questions</div>
        <div class="qs-item">Sections: <b id="qs-s">â€”</b></div>
      </div>
      <textarea class="q-area" id="q-area" placeholder='[
  {
    "section": "General Knowledge",
    "q": "What is the capital of Bihar?",
    "options": ["Gaya","Muzaffarpur","Patna","Bhagalpur"],
    "correct": 2
  }
]' oninput="liveValidate()"></textarea>
      <div class="q-msg" id="q-msg"></div>
      <div class="q-acts">
        <button class="btn b-prim" onclick="saveQ()">ğŸ’¾ Save & Publish</button>
        <button class="btn b-out"  onclick="loadQ()">ğŸ”„ Load Current</button>
        <button class="btn b-danger" onclick="clearQ()">ğŸ—‘ Clear All</button>
      </div>
    </div>
    <!-- Scores -->
    <div class="ap-card">
      <div class="ap-card-hd">
        <div><div class="ap-ct">ğŸ‘©â€ğŸ“ Student Records</div><div class="ap-cs">All attempts synced from Firebase</div></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn b-out" style="font-size:12px;padding:6px 12px" onclick="exportCSV()">â¬‡ï¸ CSV</button>
          <button class="btn b-danger" style="font-size:12px;padding:6px 12px" onclick="clearScores()">ğŸ—‘ Clear</button>
        </div>
      </div>
      <div class="tbl-bar">
        <input class="srch" id="srch" placeholder="ğŸ” Search name / emailâ€¦" oninput="renderTbl()"/>
        <select class="srt" id="srt" onchange="renderTbl()">
          <option value="time">Latest First</option>
          <option value="hi">Highest Score</option>
          <option value="lo">Lowest Score</option>
          <option value="az">Name Aâ€“Z</option>
        </select>
        <button class="btn b-blue" style="font-size:12px;padding:6px 12px" onclick="refreshScores()">â†º</button>
      </div>
      <div class="tbl-wrap">
        <table><thead><tr>
          <th>#</th><th>Name</th><th>Email / Roll</th><th>Score</th><th>%</th>
          <th>âœ…</th><th>âŒ</th><th>â¬œ</th><th>Date & Time</th>
        </tr></thead><tbody id="tbl-body"></tbody></table>
      </div>
    </div>
    <!-- Settings â€” mobile-friendly -->
    <div class="ap-card">
      <div class="ap-card-hd">
        <div><div class="ap-ct">âš™ï¸ Settings</div><div class="ap-cs">Saved to Firebase</div></div>
        <button class="btn b-prim" onclick="saveSettings()">ğŸ’¾ Save</button>
      </div>
      <div class="set-row">
        <div><div class="set-lbl">Negative Marking</div><div class="set-dsc">Deduction per wrong answer</div></div>
        <input class="set-inp" id="s-neg" type="number" min="0" max="1" step="0.25" value="0"/>
      </div>
      <div class="set-row">
        <div><div class="set-lbl">Minutes Per Question</div><div class="set-dsc">Total time = questions Ã— this</div></div>
        <input class="set-inp" id="s-mpq" type="number" min="0.5" max="3" step="0.5" value="1"/>
      </div>
      <div class="set-row">
        <div><div class="set-lbl">Shuffle Questions</div><div class="set-dsc">Randomise for each student</div></div>
        <button class="tog" id="s-shuf" onclick="togSet('s-shuf')"></button>
      </div>
      <div class="set-row">
        <div><div class="set-lbl">Show Result After Submit</div><div class="set-dsc">Display score page</div></div>
        <button class="tog on" id="s-res" onclick="togSet('s-res')"></button>
      </div>
      <div class="set-row" style="border-bottom:none">
        <div><div class="set-lbl">Change Admin Password</div><div class="set-dsc">Stored as hash in Firebase</div></div>
        <div class="pw-change-row">
          <input type="password" id="s-npw" placeholder="New password"/>
          <button class="btn b-blue" style="font-size:12px;white-space:nowrap" onclick="changePw()">Update</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• SCREEN: TEST â•â•â•â•â•â•â• -->
<div id="test" class="screen">
  <div class="th">
    <div class="th-logo">Nishu<em>Abhyasi</em></div>
    <div class="th-ctr">
      <div class="tp"><span class="tp-lbl">TIME</span><div class="tp-v" id="timer">02:00:00</div></div>
    </div>
    <div class="th-rt">
      <div class="th-cand"><div class="th-name" id="hdr-name">Candidate</div><div class="th-roll" id="hdr-roll">â€”</div></div>
      <button class="btn-fs" onclick="toggleFS()">â›¶</button>
    </div>
  </div>
  <div class="rv-ban" id="rv-ban">ğŸ” REVIEW MODE â€” Correct answers in green</div>
  <div class="pb-w"><div class="pb" id="pb" style="width:0%"></div></div>
  <div class="st-wrap" id="st-wrap"></div>
  <div class="tb">
    <div class="qp">
      <div class="q-meta">
        <span class="q-badge" id="q-num">Q 1</span>
        <div class="q-marks">
          <span class="mk-ok">âœ“ +1</span>
          <span class="mk-no" id="mk-no">âœ— -<span id="neg-v">0</span></span>
        </div>
      </div>
      <div class="qc">
        <div class="q-tx" id="q-tx">Loadingâ€¦</div>
        <img id="q-im" class="q-im" src="" alt="" style="display:none"/>
        <div class="opts" id="opts"></div>
      </div>
    </div>
    <div class="sidebar" id="sidebar">
      <div class="sb-hd">ğŸ“‹ Question Palette</div>
      <div class="sb-ci"><div class="sb-nm" id="sb-nm">â€”</div><div class="sb-rl" id="sb-rl">â€”</div></div>
      <div class="sg">
        <div class="sc"><div class="sv sv-a" id="st-a">0</div><div class="sl">âœ… Ans.</div></div>
        <div class="sc"><div class="sv sv-n" id="st-n">0</div><div class="sl">âŒ Not Ans.</div></div>
        <div class="sc"><div class="sv sv-m" id="st-m">0</div><div class="sl">ğŸŸ£ Marked</div></div>
        <div class="sc"><div class="sv sv-ma" id="st-ma">0</div><div class="sl">ğŸŸ¡ Mkd+Ans</div></div>
      </div>
      <div class="qg-sec"><div class="qg-ttl">Navigator</div><div class="qgrid" id="qgrid"></div></div>
      <div class="sb-lg">
        <div class="sbl"><div class="sbl-b" style="background:var(--c-ans)"></div>Answered</div>
        <div class="sbl"><div class="sbl-b" style="background:var(--c-no)"></div>Not Answered</div>
        <div class="sbl"><div class="sbl-b" style="background:var(--pur)"></div>Marked for Review</div>
        <div class="sbl"><div class="sbl-b" style="background:var(--amb)"></div>Marked & Answered</div>
        <div class="sbl"><div class="sbl-b" style="background:var(--c-nv)"></div>Not Visited</div>
      </div>
      <div class="sb-sub">
        <button class="btn b-sub" style="width:100%;justify-content:center" onclick="confirmSub()">ğŸ Submit Test</button>
      </div>
    </div>
  </div>
  <div class="ab">
    <button class="btn b-out" onclick="prevQ()">â—€ Prev</button>
    <button class="btn b-mark" onclick="markRev()">ğŸ´ Mark</button>
    <button class="btn b-gray" onclick="clearR()">âœ– Clear</button>
    <div class="ab-sp"></div>
    <button class="btn b-prim" onclick="saveNxt()">Next â–¶</button>
  </div>
  <button class="mob-tog" onclick="togSB()">ğŸ“‹</button>
  <div class="sb-ov" id="sb-ov" onclick="togSB()"></div>
</div>

<!-- â•â•â•â•â•â•â• SCREEN: RESULT â•â•â•â•â•â•â• -->
<div id="result" class="screen">
  <div class="rc-out">
    <div class="rc">
      <div class="rc-hd">
        <div style="font-size:36px;margin-bottom:5px">ğŸ“</div>
        <h2>Test Completed!</h2>
        <p id="res-cand">Bihar B.Ed CET</p>
      </div>
      <div class="rc-sa">
        <div class="sr-w">
          <svg class="sr-svg" viewBox="0 0 140 140">
            <circle class="sr-bg" cx="70" cy="70" r="56"/>
            <circle class="sr-f" id="sr" cx="70" cy="70" r="56" stroke-dasharray="351.86" stroke-dashoffset="351.86" stroke="var(--sf)"/>
          </svg>
          <div class="sr-tx"><div class="sr-pct" id="res-pct">0%</div><div class="sr-lb">Score</div></div>
        </div>
        <div class="sd">
          <div class="sd-tot" id="res-sc">0 / â€”</div>
          <div class="sd-row">Correct Ã— 1 = <b id="sd-c">0</b></div>
          <div class="sd-row">Penalty = <b id="sd-n" style="color:var(--c-no)">0</b></div>
          <div class="sd-row">Net: <b id="sd-net">0</b></div>
        </div>
      </div>
      <div class="rc-st">
        <div class="rs rs-c"><div class="rv" id="res-cor">0</div><div class="rl">âœ… Correct</div></div>
        <div class="rs rs-w"><div class="rv" id="res-wr">0</div><div class="rl">âŒ Wrong</div></div>
        <div class="rs rs-s"><div class="rv" id="res-sk">0</div><div class="rl">â¬œ Skipped</div></div>
      </div>
      <div class="rc-msg" id="res-msg"></div>
      <div class="rc-act">
        <button class="rc-btn rcb-rv" onclick="reviewTest()">ğŸ” Review</button>
        <button class="rc-btn rcb-rs" onclick="doFresh()">ğŸ”„ New Test</button>
      </div>
    </div>
    <footer class="ft">
      <span class="ft-br">Nishu<em>Abhyasi</em></span>
      An app by <strong style="color:#fff">Yashwant</strong> &nbsp;|&nbsp; Â© 2025
    </footer>
  </div>
</div>

<!-- Submit Modal -->
<div class="mo" id="mo">
  <div class="md">
    <h3>âš ï¸ Submit Test?</h3>
    <p>Once submitted you cannot change answers.</p>
    <div class="md-st" id="md-st"></div>
    <div class="md-bt">
      <button class="btn b-out" onclick="closeM()">Cancel</button>
      <button class="btn b-sub" onclick="doSubmit()">Submit Now</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN SCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

/* â•â• Firebase helpers â•â• */
const db   = ()=> window._db;
const auth = ()=> window._auth;
const fs   = ()=> window._fs;
const fa   = ()=> window._fauth;

async function fbGet(path){
  const [c,...r]=path.split('/');const {doc,getDoc}=fs();
  const s=await getDoc(doc(db(),c,r.join('/')));
  return s.exists()?s.data():null;
}
async function fbSet(path,data){
  const [c,...r]=path.split('/');const {doc,setDoc}=fs();
  await setDoc(doc(db(),c,r.join('/')),data);
}
async function fbAdd(col,data){
  const {collection,addDoc}=fs();
  await addDoc(collection(db(),col),{...data,ts:Date.now()});
}
async function fbGetAll(col){
  const {collection,getDocs,query,orderBy}=fs();
  const s=await getDocs(query(collection(db(),col),orderBy('ts','desc')));
  return s.docs.map(d=>({id:d.id,...d.data()}));
}
async function fbDelAll(col){
  const {collection,getDocs,deleteDoc,doc}=fs();
  const s=await getDocs(collection(db(),col));
  await Promise.all(s.docs.map(d=>deleteDoc(doc(db(),col,d.id))));
}
async function fbGetUserAttempts(uid){
  const {collection,getDocs,query,orderBy,limit}=fs();
  const s=await getDocs(query(collection(db(),`users/${uid}/attempts`),orderBy('ts','desc'),limit(5)));
  return s.docs.map(d=>({id:d.id,...d.data()}));
}
async function fbAddUserAttempt(uid,data){
  const {collection,addDoc}=fs();
  await addDoc(collection(db(),`users/${uid}/attempts`),{...data,ts:Date.now()});
}

/* â•â• SHA-256 â•â• */
async function sha256(s){
  const b=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));
  return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('');
}

/* â•â• State â•â• */
let Q=[],secs=[],curSec=0,curQ=0;
let ans=[],vis=[],mkd=[],tLeft=7200,tInt=null;
let isRev=false,negM=0,cName='',cRoll='',cEmail='',active=false;
let settings={negM:0,mpq:1,shuffle:false,showResult:true};
let allScores=[];
let adminIn=false;
let curUser=null;
let isGuest=false;

const SS='na_v5';

/* â•â• SPLASH â•â• */
const MSGS=['Connecting to Firebaseâ€¦','Loading question bankâ€¦','Checking authenticationâ€¦','Almost readyâ€¦','Welcome! ğŸ‰'];
function runSplash(){
  return new Promise(res=>{
    const bar=document.getElementById('sp-bf'),msg=document.getElementById('sp-mg');
    let s=0;const TOT=40;
    const iv=setInterval(()=>{
      s++;bar.style.width=(s/TOT*100)+'%';
      msg.textContent=MSGS[Math.min(Math.floor(s/TOT*MSGS.length),MSGS.length-1)];
      if(s>=TOT){clearInterval(iv);setTimeout(res,200);}
    },100);
  });
}
function hideSplash(){
  const sp=document.getElementById('splash');
  sp.style.transition='opacity 0.5s';sp.style.opacity='0';
  setTimeout(()=>sp.style.display='none',500);
}

/* â•â• BOOT â•â• */
const FIREBASE_CONFIG={apiKey:document.querySelector('script[type="module"]')?.textContent?.match(/apiKey:\s*"([^"]+)"/)?.[1]||''};

window.addEventListener('dbready',async()=>{
  if(!window._dbReady){
    await runSplash();hideSplash();
    document.getElementById('db-setup').classList.add('on');
    return;
  }
  await Promise.all([runSplash(),bootLoad()]);
  hideSplash();
  finishBoot();
});

async function bootLoad(){
  try{
    const s=await fbGet('config/settings');
    if(s) Object.assign(settings,s);
    negM=settings.negM||0;
    const qd=await fbGet('config/questions');
    if(qd&&Array.isArray(qd.data)&&qd.data.length)
      Q=settings.shuffle?shuffle([...qd.data]):qd.data;
  }catch(e){console.warn('Boot error:',e.message);}
}

function finishBoot(){
  try{
    const saved=JSON.parse(sessionStorage.getItem(SS));
    if(saved&&saved.ans&&Q.length&&saved.ans.length===Q.length){
      restoreSessionState(saved);
      setupAuthListener(true);
      return;
    }
  }catch(e){}
  setupAuthListener(false);
}

function setupAuthListener(hasSession){
  const {onAuthStateChanged}=fa();
  onAuthStateChanged(auth(),(user)=>{
    curUser=user;
    isGuest=false;
    if(hasSession){
      showRefreshGuard();
      return;
    }
    if(user){
      showLanding();
    } else {
      const wasGuest=sessionStorage.getItem('na_guest');
      if(wasGuest==='1'){isGuest=true;showLanding();}
      else showScreen('auth');
    }
  });
}

function showRefreshGuard(){
  document.getElementById('rg').classList.add('on');
}

/* â•â• AUTH SCREEN â•â• */
function switchAuthTab(tab){
  document.getElementById('tab-si').classList.toggle('on',tab==='si');
  document.getElementById('tab-su').classList.toggle('on',tab==='su');
  document.getElementById('panel-si').classList.toggle('on',tab==='si');
  document.getElementById('panel-su').classList.toggle('on',tab==='su');
  document.getElementById('si-err').textContent='';
  document.getElementById('su-err').textContent='';
}

async function doSignIn(){
  const email=document.getElementById('si-email').value.trim();
  const pw=document.getElementById('si-pw').value;
  const errEl=document.getElementById('si-err');
  const btn=document.getElementById('si-btn');
  if(!email||!pw){errEl.textContent='Please fill in all fields.';return;}
  btn.disabled=true;btn.textContent='Signing inâ€¦';errEl.textContent='';
  try{
    const {signInWithEmailAndPassword}=fa();
    await signInWithEmailAndPassword(auth(),email,pw);
    sessionStorage.removeItem('na_guest');
    btn.disabled=false;btn.textContent='â†’ Sign In';
  }catch(e){
    btn.disabled=false;btn.textContent='â†’ Sign In';
    errEl.textContent=friendlyAuthError(e.code);
  }
}

async function doSignUp(){
  const name=document.getElementById('su-name').value.trim();
  const email=document.getElementById('su-email').value.trim();
  const pw=document.getElementById('su-pw').value;
  const pw2=document.getElementById('su-pw2').value;
  const errEl=document.getElementById('su-err');
  const btn=document.getElementById('su-btn');
  if(!name||!email||!pw||!pw2){errEl.textContent='Please fill in all fields.';return;}
  if(pw!==pw2){errEl.textContent='Passwords do not match.';return;}
  if(pw.length<6){errEl.textContent='Password must be at least 6 characters.';return;}
  btn.disabled=true;btn.textContent='Creating accountâ€¦';errEl.textContent='';
  try{
    const {createUserWithEmailAndPassword,updateProfile}=fa();
    const cred=await createUserWithEmailAndPassword(auth(),email,pw);
    await updateProfile(cred.user,{displayName:name});
    sessionStorage.removeItem('na_guest');
    btn.disabled=false;btn.textContent='âœ” Create Account';
    toast('ğŸ‰ Account created! Welcome, '+name);
  }catch(e){
    btn.disabled=false;btn.textContent='âœ” Create Account';
    errEl.textContent=friendlyAuthError(e.code);
  }
}

function goGuest(){
  curUser=null;isGuest=true;
  sessionStorage.setItem('na_guest','1');
  showLanding();
}

async function doSignOut(){
  const {signOut}=fa();
  try{await signOut(auth());}catch(e){}
  curUser=null;isGuest=false;
  sessionStorage.removeItem('na_guest');
  showScreen('auth');
}

function friendlyAuthError(code){
  const m={
    'auth/user-not-found':'No account found with this email.',
    'auth/wrong-password':'Incorrect password.',
    'auth/invalid-email':'Please enter a valid email address.',
    'auth/email-already-in-use':'This email is already registered. Sign in instead.',
    'auth/weak-password':'Password is too weak (min 6 characters).',
    'auth/too-many-requests':'Too many attempts. Please try again later.',
    'auth/invalid-credential':'Incorrect email or password.',
    'auth/network-request-failed':'Network error. Check your internet connection.'
  };
  return m[code]||'Authentication error: '+code;
}

function toggleEyeId(id){const i=document.getElementById(id);i.type=i.type==='password'?'text':'password';}

/* â•â• LANDING SCREEN â•â• */
async function showLanding(){
  updateLandingInfo();

  if(curUser){
    document.getElementById('user-badge').style.display='flex';
    document.getElementById('guest-badge').style.display='none';
    document.getElementById('guest-fields').style.display='none';
    document.getElementById('loggedin-fields').style.display='block';
    document.getElementById('c-name').value=curUser.displayName||'';
    document.getElementById('ub-av').textContent=(curUser.displayName||'?')[0].toUpperCase();
    document.getElementById('ub-name').textContent=curUser.displayName||'Student';
    document.getElementById('ub-email').textContent=curUser.email||'';
    document.getElementById('hist-section').style.display='block';
    loadAttemptHistory();
  }else{
    document.getElementById('user-badge').style.display='none';
    document.getElementById('guest-badge').style.display='flex';
    document.getElementById('guest-fields').style.display='block';
    document.getElementById('loggedin-fields').style.display='none';
    document.getElementById('hist-section').style.display='none';
  }

  showScreen('landing');
}

async function loadAttemptHistory(){
  if(!curUser) return;
  const list=document.getElementById('hist-list');
  list.innerHTML='<div style="font-size:13px;color:var(--mt);padding:6px 0">Loadingâ€¦</div>';
  try{
    const attempts=await fbGetUserAttempts(curUser.uid);
    if(!attempts.length){
      list.innerHTML='<div style="font-size:13px;color:var(--mt);padding:6px 0">No attempts yet. Take your first test!</div>';
      return;
    }
    const colors=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£','5ï¸âƒ£'];
    list.innerHTML=attempts.map((a,i)=>{
      const pct=a.pct||0;
      const col=pct>=60?'var(--gn)':pct>=40?'var(--sf)':'var(--c-no)';
      return `<div class="hist-item">
        <div class="hi-rank">${colors[i]||i+1}</div>
        <div class="hi-info">
          <div style="font-size:13px;font-weight:600;color:var(--tx)">${a.score}/${a.total} marks</div>
          <div class="hi-date">${fmtDate(a.timestamp)}</div>
        </div>
        <div>
          <div class="hi-score" style="color:${col}">${pct}%</div>
          <div class="hi-pct">âœ…${a.correct} âŒ${a.wrong} â¬œ${a.skipped}</div>
        </div>
      </div>`;
    }).join('');
  }catch(e){
    list.innerHTML='<div style="font-size:13px;color:var(--c-no)">Could not load history.</div>';
  }
}

function updateLandingInfo(){
  document.getElementById('info-tot').textContent=Q.length||'â€”';
  document.getElementById('info-min').textContent=Q.length?Math.ceil(Q.length*(settings.mpq||1)):'â€”';
  document.getElementById('info-neg').textContent=settings.negM||'0';
  if(Q.length===0){document.getElementById('no-q').classList.add('on');document.getElementById('btn-st').disabled=true;}
  else{document.getElementById('no-q').classList.remove('on');document.getElementById('btn-st').disabled=false;}
}

/* â•â• SESSION â•â• */
function saveSession(){
  if(!active)return;
  try{sessionStorage.setItem(SS,JSON.stringify({cName,cRoll,cEmail,curQ,tLeft,ans,vis,mkd,negM}));}catch(e){}
}
function clearSess(){try{sessionStorage.removeItem(SS);}catch(e){}}
function restoreSessionState(s){
  cName=s.cName||'Candidate';cRoll=s.cRoll||'â€”';cEmail=s.cEmail||'';
  curQ=s.curQ||0;tLeft=s.tLeft||Q.length*60;
  ans=s.ans;vis=s.vis;mkd=s.mkd;negM=s.negM||0;
}

function doResume(){
  document.getElementById('rg').classList.remove('on');
  buildSecs();active=true;setHdr();
  showScreen('test');buildTabs();buildGrid();renderQ(curQ);startTimer();
}
function doFresh(){
  clearSess();clearInterval(tInt);active=false;isRev=false;
  document.getElementById('rg').classList.remove('on');
  document.getElementById('rv-ban').classList.remove('on');
  document.querySelectorAll('.ab .btn').forEach(b=>b.style.display='');
  showLanding();
}

/* â•â• START TEST â•â• */
function startTest(){
  if(!Q.length){toast('No questions available.');return;}
  if(curUser){
    cName=document.getElementById('c-name').value.trim()||curUser.displayName||'Student';
    cRoll=document.getElementById('c-roll').value.trim()||'â€”';
    cEmail=curUser.email||'';
  }else{
    cName=document.getElementById('c-name').value.trim()||'Guest';
    cEmail=document.getElementById('c-email').value.trim()||'';
    cRoll='â€”';
  }
  buildSecs();
  ans=Array(Q.length).fill(null);vis=Array(Q.length).fill(false);mkd=Array(Q.length).fill(false);
  negM=settings.negM||0;isRev=false;curQ=0;curSec=0;
  tLeft=Math.round(Q.length*(settings.mpq||1)*60);active=true;
  if(negM>0){document.getElementById('mk-no').classList.add('on');document.getElementById('neg-v').textContent=negM;}
  setHdr();showScreen('test');buildTabs();buildGrid();renderQ(0);startTimer();saveSession();
}
function setHdr(){
  document.getElementById('hdr-name').textContent=cName;
  document.getElementById('hdr-roll').textContent=cEmail||cRoll;
  document.getElementById('sb-nm').textContent=cName;
  document.getElementById('sb-rl').textContent=cEmail||cRoll;
}
function buildSecs(){
  const m={};Q.forEach((q,i)=>{const s=q.section||'General';if(!m[s])m[s]=[];m[s].push(i);});
  secs=Object.entries(m).map(([n,ix])=>({n,ix}));
}

/* â•â• FIX: showScreen â€” forcefully remove .active from ALL screens first â•â• */
function showScreen(id){
  // Remove active from every screen
  document.querySelectorAll('.screen').forEach(s=>{
    s.classList.remove('active');
  });
  // Activate only the requested screen
  const target = document.getElementById(id);
  if(target) target.classList.add('active');
  // Scroll to top for non-test screens
  if(id !== 'test') window.scrollTo(0,0);
}

function buildTabs(){
  const w=document.getElementById('st-wrap');w.innerHTML='';
  secs.forEach((s,i)=>{const t=document.createElement('div');t.className='st'+(i===0?' on':'');t.textContent=s.n;t.onclick=()=>swSec(i);w.appendChild(t);});
}
function swSec(i){curSec=i;document.querySelectorAll('.st').forEach((t,j)=>t.classList.toggle('on',j===i));renderQ(secs[i].ix[0]);}
function buildGrid(){
  const g=document.getElementById('qgrid');g.innerHTML='';
  Q.forEach((_,i)=>{const b=document.createElement('button');b.className='qb';b.id='qb'+i;b.textContent=i+1;b.onclick=()=>renderQ(i);g.appendChild(b);});
  refGrid();
}
function refGrid(){
  Q.forEach((_,i)=>{
    const b=document.getElementById('qb'+i);if(!b)return;
    b.className='qb';
    if(i===curQ)b.classList.add('cur');
    if(mkd[i]&&ans[i]!==null)b.classList.add('mka');
    else if(mkd[i])b.classList.add('mk');
    else if(ans[i]!==null)b.classList.add('ans');
    else if(vis[i])b.classList.add('no');
  });
  refStats();
}
function refStats(){
  const a=ans.filter(x=>x!==null).length,n=vis.filter((v,i)=>v&&ans[i]===null).length;
  const m=mkd.filter((v,i)=>v&&ans[i]===null).length,ma=mkd.filter((v,i)=>v&&ans[i]!==null).length;
  document.getElementById('st-a').textContent=a;document.getElementById('st-n').textContent=n;
  document.getElementById('st-m').textContent=m;document.getElementById('st-ma').textContent=ma;
  document.getElementById('pb').style.width=(a/Q.length*100)+'%';
}
function renderQ(idx){
  curQ=idx;vis[idx]=true;
  const si=secs.findIndex(s=>s.ix.includes(idx));
  if(si!==-1&&si!==curSec){curSec=si;document.querySelectorAll('.st').forEach((t,j)=>t.classList.toggle('on',j===si));}
  const q=Q[idx];
  document.getElementById('q-num').textContent=`Q ${idx+1} of ${Q.length}`;
  document.getElementById('q-tx').textContent=q.q||q.question||'(No question text)';
  const im=document.getElementById('q-im');
  if(q.image){im.src=q.image;im.style.display='block';}else im.style.display='none';
  const ol=document.getElementById('opts');ol.innerHTML='';
  const ks=['A','B','C','D','E'];
  (q.options||[]).forEach((o,i)=>{
    const b=document.createElement('button');b.className='opt';
    if(ans[idx]===i)b.classList.add('sel');
    if(isRev){if(i===q.correct)b.classList.add('cor');else if(ans[idx]===i)b.classList.add('inc');}
    b.innerHTML=`<span class="opt-k">${ks[i]}</span><span class="opt-tx">${o}</span>`;
    if(!isRev)b.onclick=()=>selOpt(i);
    ol.appendChild(b);
  });
  refGrid();
  const gb=document.getElementById('qb'+idx);if(gb)gb.scrollIntoView({block:'nearest',behavior:'smooth'});
  saveSession();
}
function selOpt(i){ans[curQ]=i;renderQ(curQ);}
function saveNxt(){goNxt();}
function markRev(){mkd[curQ]=true;goNxt();}
function clearR(){ans[curQ]=null;renderQ(curQ);toast('Response cleared');}
function prevQ(){if(curQ>0)renderQ(curQ-1);}
function goNxt(){if(curQ<Q.length-1)renderQ(curQ+1);else toast('Last question!');}
function startTimer(){
  clearInterval(tInt);showTimer();
  tInt=setInterval(()=>{tLeft--;showTimer();if(tLeft%30===0)saveSession();if(tLeft<=0){clearInterval(tInt);doSubmit();}},1000);
}
function showTimer(){
  const h=Math.floor(tLeft/3600),m=Math.floor((tLeft%3600)/60),s=tLeft%60;
  const el=document.getElementById('timer');
  el.textContent=`${p(h)}:${p(m)}:${p(s)}`;el.className='tp-v';
  if(tLeft<=300)el.classList.add('danger');else if(tLeft<=600)el.classList.add('warn');
}
const p=n=>String(n).padStart(2,'0');

function confirmSub(){
  const a=ans.filter(x=>x!==null).length;
  document.getElementById('md-st').innerHTML=`
    <div class="ms">Total: <span>${Q.length}</span></div><div class="ms">Answered: <span>${a}</span></div>
    <div class="ms">Skipped: <span>${Q.length-a}</span></div><div class="ms">Marked: <span>${mkd.filter(x=>x).length}</span></div>`;
  document.getElementById('mo').classList.add('on');
}
function closeM(){document.getElementById('mo').classList.remove('on');}

async function doSubmit(){
  closeM();clearInterval(tInt);active=false;clearSess();
  let c=0,w=0,sk=0;
  Q.forEach((q,i)=>{if(ans[i]===null)sk++;else if(ans[i]===q.correct)c++;else w++;});
  const net=+(c-(negM*w)).toFixed(2),tot=Q.length,pct=Math.max(0,Math.round((net/tot)*100));
  const record={name:cName,roll:cRoll,email:cEmail||curUser?.email||'â€”',score:net,total:tot,pct,correct:c,wrong:w,skipped:sk,timestamp:new Date().toISOString()};

  try{await fbAdd('scores',record);}catch(e){console.warn('Global score save failed:',e.message);}
  if(curUser){
    try{await fbAddUserAttempt(curUser.uid,record);}catch(e){console.warn('User attempt save failed:',e.message);}
  }

  if(!settings.showResult){doFresh();return;}

  document.getElementById('res-cand').textContent=cName+(cEmail?' | '+cEmail:'');
  document.getElementById('res-pct').textContent=pct+'%';
  document.getElementById('res-sc').textContent=`${net} / ${tot}`;
  document.getElementById('res-cor').textContent=c;document.getElementById('res-wr').textContent=w;
  document.getElementById('res-sk').textContent=sk;document.getElementById('sd-c').textContent=c;
  document.getElementById('sd-n').textContent=(negM*w).toFixed(2);document.getElementById('sd-net').textContent=net;
  const msg=pct>=80?'ğŸŒŸ Outstanding performance!':pct>=60?'ğŸ‘ Good job!':pct>=40?'ğŸ’ª Keep practising.':'ğŸ“š More practice needed.';
  document.getElementById('res-msg').textContent=msg;
  const circ=351.86,off=circ-(circ*pct/100);
  setTimeout(()=>{const r=document.getElementById('sr');r.style.strokeDashoffset=off;r.style.stroke=pct>=60?'var(--gn)':pct>=40?'var(--sf)':'var(--c-no)';},250);
  showScreen('result');
}
function reviewTest(){
  isRev=true;showScreen('test');document.getElementById('rv-ban').classList.add('on');
  document.getElementById('timer').textContent='00:00:00';
  document.querySelectorAll('.ab .btn').forEach(b=>{if(b.getAttribute('onclick')&&['saveNxt','markRev','clearR'].some(f=>b.getAttribute('onclick').includes(f)))b.style.display='none';});
  renderQ(0);
}
function togSB(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sb-ov').classList.toggle('on');}
function toggleFS(){if(!document.fullscreenElement)document.documentElement.requestFullscreen().catch(()=>{});else document.exitFullscreen().catch(()=>{});}
window.addEventListener('beforeunload',e=>{if(active){saveSession();e.preventDefault();e.returnValue='';}});
document.addEventListener('keydown',e=>{
  if(!document.getElementById('test').classList.contains('active')||isRev)return;
  if(e.key==='ArrowRight'||e.key==='Enter')saveNxt();
  else if(e.key==='ArrowLeft')prevQ();
  else if(['1','2','3','4'].includes(e.key))selOpt(+e.key-1);
  else if(e.key==='m'||e.key==='M')markRev();
  else if(e.key==='c'||e.key==='C')clearR();
});
document.addEventListener('visibilitychange',()=>{if(document.getElementById('test').classList.contains('active')&&!isRev&&document.hidden)toast('âš ï¸ Do not switch tabs!');});
document.addEventListener('contextmenu',e=>{if(document.getElementById('test').classList.contains('active')&&!isRev)e.preventDefault();});
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

/* â•â• ADMIN â•â• */
async function goAdmin(){
  showScreen('admin-login');
  const pwDoc=await fbGet('config/admin');
  if(!pwDoc||!pwDoc.hash){
    document.getElementById('setup-box').style.display='block';
    document.getElementById('al-hint').textContent='No password set. Create your first admin password:';
    document.getElementById('al-btn').textContent='ğŸ”‘ Create Password & Enter';
  }else{
    document.getElementById('setup-box').style.display='none';
    document.getElementById('al-hint').textContent='Enter your admin password to continue.';
    document.getElementById('al-btn').textContent='ğŸ”“ Login to Admin Panel';
  }
  document.getElementById('al-err').textContent='';
  document.getElementById('al-pw').value='';
  setTimeout(()=>document.getElementById('al-pw').focus(),200);
}
async function doAdminLogin(){
  const pw=document.getElementById('al-pw').value;
  const errEl=document.getElementById('al-err'),btn=document.getElementById('al-btn');
  if(!pw){errEl.textContent='Please enter a password.';return;}
  if(pw.length<6){errEl.textContent='Password must be at least 6 characters.';return;}
  btn.disabled=true;btn.textContent='Verifyingâ€¦';
  try{
    const hash=await sha256(pw);
    const pwDoc=await fbGet('config/admin');
    if(!pwDoc||!pwDoc.hash){
      await fbSet('config/admin',{hash,createdAt:new Date().toISOString()});
      adminIn=true;btn.disabled=false;toast('âœ… Admin password created!');openAdmin();
    }else if(hash===pwDoc.hash){
      adminIn=true;btn.disabled=false;openAdmin();
    }else{
      btn.disabled=false;btn.textContent='ğŸ”“ Login to Admin Panel';
      errEl.textContent='âŒ Incorrect password.';
      document.getElementById('al-pw').value='';
    }
  }catch(e){btn.disabled=false;btn.textContent='ğŸ”“ Login';errEl.textContent='Error: '+e.message;}
}
async function openAdmin(){showScreen('admin-panel');await loadAdminData();}
function adminOut(){adminIn=false;showLanding();toast('Logged out.');}
function reqAdmin(){if(!adminIn){showScreen('admin-login');return false;}return true;}

async function loadAdminData(){
  if(!reqAdmin())return;
  const qd=await fbGet('config/questions');
  const qs=(qd&&Array.isArray(qd.data))?qd.data:[];
  document.getElementById('ap-nq').textContent=qs.length||'0';
  document.getElementById('qs-n').textContent=qs.length||'0';
  if(qs.length){const secSet=new Set(qs.map(q=>q.section||'General'));document.getElementById('qs-s').textContent=[...secSet].join(', ');}
  if(qd&&qd.updatedAt){document.getElementById('lu').classList.add('on');document.getElementById('lu-t').textContent='Updated: '+fmtDate(qd.updatedAt);}
  await refreshScores();
  const s=await fbGet('config/settings');if(s)Object.assign(settings,s);
  document.getElementById('s-neg').value=settings.negM||0;
  document.getElementById('s-mpq').value=settings.mpq||1;
  if(settings.shuffle)document.getElementById('s-shuf').classList.add('on');else document.getElementById('s-shuf').classList.remove('on');
  if(settings.showResult!==false)document.getElementById('s-res').classList.add('on');else document.getElementById('s-res').classList.remove('on');
}
async function refreshScores(){
  try{
    allScores=await fbGetAll('scores');
    document.getElementById('ap-na').textContent=allScores.length;
    if(allScores.length){
      const avg=allScores.reduce((s,r)=>s+(r.pct||0),0)/allScores.length;
      const top=Math.max(...allScores.map(r=>r.pct||0));
      document.getElementById('ap-av').textContent=avg.toFixed(1)+'%';
      document.getElementById('ap-tp').textContent=top+'%';
    }else{document.getElementById('ap-av').textContent='â€”';document.getElementById('ap-tp').textContent='â€”';}
    renderTbl();
  }catch(e){toast('Error loading scores: '+e.message);}
}
function renderTbl(){
  let rows=[...allScores];
  const srch=(document.getElementById('srch')?.value||'').toLowerCase();
  const srt=document.getElementById('srt')?.value||'time';
  if(srch)rows=rows.filter(r=>(r.name||'').toLowerCase().includes(srch)||(r.email||'').toLowerCase().includes(srch));
  rows.sort((a,b)=>{
    if(srt==='hi')return (b.pct||0)-(a.pct||0);
    if(srt==='lo')return (a.pct||0)-(b.pct||0);
    if(srt==='az')return (a.name||'').localeCompare(b.name||'');
    return (b.ts||0)-(a.ts||0);
  });
  const tbody=document.getElementById('tbl-body');
  if(!rows.length){tbody.innerHTML=`<tr><td colspan="9" class="tbl-empty">ğŸ“­ No attempts yet.</td></tr>`;return;}
  tbody.innerHTML=rows.map((r,i)=>{
    const cls=r.pct>=60?'sb-hi':r.pct>=40?'sb-md':'sb-lo';
    return `<tr>
      <td style="color:var(--mt);font-size:12px">${i+1}</td>
      <td style="font-weight:600">${esc(r.name||'â€”')}</td>
      <td style="font-size:12px;color:var(--mt)">${esc(r.email||r.roll||'â€”')}</td>
      <td><span class="sb ${cls}">${r.score}/${r.total}</span></td>
      <td><b>${r.pct}%</b></td>
      <td style="color:var(--gn);font-weight:700">${r.correct}</td>
      <td style="color:var(--c-no);font-weight:700">${r.wrong}</td>
      <td style="color:var(--mt)">${r.skipped}</td>
      <td style="font-size:12px;color:var(--mt)">${fmtDate(r.timestamp)}</td>
    </tr>`;
  }).join('');
}
async function clearScores(){
  if(!reqAdmin())return;
  if(!confirm('Delete ALL score records from Firebase?'))return;
  await fbDelAll('scores');allScores=[];
  document.getElementById('ap-na').textContent='0';document.getElementById('ap-av').textContent='â€”';document.getElementById('ap-tp').textContent='â€”';
  renderTbl();toast('Records cleared.');
}
async function exportCSV(){
  if(!reqAdmin()||!allScores.length){toast('No records to export.');return;}
  const h='Name,Email/Roll,Score,Total,%,Correct,Wrong,Skipped,Timestamp\n';
  const rows=allScores.map(r=>`"${r.name}","${r.email||r.roll}",${r.score},${r.total},${r.pct}%,${r.correct},${r.wrong},${r.skipped},"${fmtDate(r.timestamp)}"`).join('\n');
  const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([h+rows],{type:'text/csv'})),download:`nishuabhyasi_${new Date().toISOString().slice(0,10)}.csv`});
  a.click();toast('CSV exported!');
}

/* Questions */
function liveValidate(){
  const txt=document.getElementById('q-area').value.trim();
  const msg=document.getElementById('q-msg'),area=document.getElementById('q-area');
  if(!txt){msg.textContent='';area.className='q-area';return false;}
  try{
    const d=JSON.parse(txt);
    if(!Array.isArray(d)||!d.length)throw new Error('Must be a non-empty JSON array');
    const mq=d.filter(q=>!q.q&&!q.question).length;
    const mc=d.filter(q=>q.correct===undefined).length;
    if(mq)throw new Error(`${mq} questions missing "q" field`);
    if(mc)throw new Error(`${mc} questions missing "correct" field`);
    area.className='q-area ok';msg.className='q-msg ok';
    const secs=new Set(d.map(q=>q.section||'General'));
    msg.textContent=`âœ… Valid â€” ${d.length} questions, ${secs.size} section(s)`;
    return true;
  }catch(e){area.className='q-area bad';msg.className='q-msg bad';msg.textContent='âŒ '+e.message;return false;}
}
async function saveQ(){
  if(!reqAdmin()||!liveValidate())return;
  const data=JSON.parse(document.getElementById('q-area').value.trim());
  const now=new Date().toISOString();
  await fbSet('config/questions',{data,updatedAt:now});
  Q=settings.shuffle?shuffle([...data]):data;
  updateLandingInfo();
  document.getElementById('ap-nq').textContent=data.length;
  document.getElementById('qs-n').textContent=data.length;
  const secs=new Set(data.map(q=>q.section||'General'));
  document.getElementById('qs-s').textContent=[...secs].join(', ');
  document.getElementById('lu').classList.add('on');
  document.getElementById('lu-t').textContent='Updated: '+fmtDate(now);
  toast(`âœ… ${data.length} questions published!`);
}
async function loadQ(){
  if(!reqAdmin())return;
  const qd=await fbGet('config/questions');
  if(!qd||!qd.data||!qd.data.length){toast('No questions in Firebase yet.');return;}
  document.getElementById('q-area').value=JSON.stringify(qd.data,null,2);
  liveValidate();toast(`Loaded ${qd.data.length} questions.`);
}
async function clearQ(){
  if(!reqAdmin())return;
  if(!confirm('Clear ALL questions?'))return;
  await fbSet('config/questions',{data:[],updatedAt:new Date().toISOString()});
  Q=[];updateLandingInfo();
  document.getElementById('q-area').value='';document.getElementById('q-msg').textContent='';
  document.getElementById('q-area').className='q-area';
  document.getElementById('ap-nq').textContent='0';document.getElementById('qs-n').textContent='0';
  document.getElementById('qs-s').textContent='â€”';document.getElementById('lu').classList.remove('on');
  toast('Questions cleared.');
}

/* Settings */
function togSet(id){document.getElementById(id).classList.toggle('on');}
async function saveSettings(){
  if(!reqAdmin())return;
  settings.negM=parseFloat(document.getElementById('s-neg').value)||0;
  settings.mpq=parseFloat(document.getElementById('s-mpq').value)||1;
  settings.shuffle=document.getElementById('s-shuf').classList.contains('on');
  settings.showResult=document.getElementById('s-res').classList.contains('on');
  await fbSet('config/settings',settings);
  negM=settings.negM;updateLandingInfo();
  toast('âœ… Settings saved!');
}
async function changePw(){
  if(!reqAdmin())return;
  const np=document.getElementById('s-npw').value.trim();
  if(!np||np.length<6){toast('Password must be at least 6 characters.');return;}
  const hash=await sha256(np);
  await fbSet('config/admin',{hash,updatedAt:new Date().toISOString()});
  document.getElementById('s-npw').value='';
  toast('âœ… Admin password updated!');
}

/* Utils */
function fmtDate(iso){try{const d=new Date(iso);return d.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'})+' '+d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});}catch(e){return iso;}}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
let _tt;
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('on');clearTimeout(_tt);_tt=setTimeout(()=>t.classList.remove('on'),2800);}
</script>
</body>
</html>
