<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>NishuAbhyasi â€“ Bihar B.Ed CET</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&family=Noto+Sans:wght@400;500;600&display=swap" rel="stylesheet"/>

<!-- â•â•â• FIREBASE SDK (CDN, no install needed) â•â•â• -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, addDoc, collection,
         getDocs, deleteDoc, query, orderBy }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ”§ FIREBASE CONFIG â€” PASTE YOUR CONFIG HERE
   
   Steps (5 minutes, totally free):
   1. Go to https://console.firebase.google.com
   2. Click "Add project" â†’ name it "nishuabhyasi" â†’ Continue
   3. Disable Google Analytics â†’ Create project
   4. Click "Web" (</>) icon â†’ Register app â†’ Copy the config below
   5. Left menu: Build â†’ Firestore Database â†’ Create database
      â†’ Start in TEST mode â†’ Choose nearest region â†’ Done
   6. Paste your config in the object below (replace the placeholders)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyBU7F9S_FrLQbilvu48-pIBd7DlvJVz8x4",
  authDomain:        "nishuabhyasi-2-0.firebaseapp.com",
  projectId:         "nishuabhyasi-2-0",
  storageBucket:     "nishuabhyasi-2-0.firebasestorage.app",
  messagingSenderId: "421828170852",
  appId:             "1:421828170852:web:a2ec5d7936a35fb32bbb71"
};
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Expose DB to the rest of the page via globals â”€â”€
let app, db;
try {
  app = initializeApp(FIREBASE_CONFIG);
  db  = getFirestore(app);
  window._db     = db;
  window._dbReady = true;
  // Expose Firestore helpers globally
  window._fs = { doc, getDoc, setDoc, addDoc, collection, getDocs, deleteDoc, query, orderBy };
} catch(e) {
  window._dbReady = false;
  window._dbError = e.message;
}
window.dispatchEvent(new Event('dbready'));
</script>

<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --sf:#FF6B00;--sf-lt:#FFF3E8;--sf-dk:#C94E00;
  --gn:#138808;--gn-lt:#E8F5E9;
  --bl:#0057A8;--bl-lt:#E3F0FF;--bl-dk:#003d7a;
  --nv:#0a1628;--pur:#A855F7;--amb:#F59E0B;
  --bg:#EEF1F8;--tx:#1A1A2E;--mt:#6B7280;--bd:#E2E8F0;
  --c-ans:#138808;--c-no:#EF4444;--c-mk:#A855F7;--c-mka:#F59E0B;--c-nv:#94A3B8;
  --sh:0 2px 16px rgba(0,0,0,.07);--sh2:0 8px 32px rgba(0,0,0,.13);
  --fh:'Baloo 2',cursive;--fb:'Noto Sans',sans-serif;
}
html,body{height:100%;font-family:var(--fb);background:var(--bg);color:var(--tx);overflow-x:hidden}
.screen{display:none;min-height:100vh;flex-direction:column}
.screen.active{display:flex}

@keyframes spin   {to{transform:rotate(360deg)}}
@keyframes spinF  {to{transform:rotate(360deg)}}
@keyframes pulse  {0%,100%{opacity:.35}50%{opacity:1}}
@keyframes blink  {0%,100%{opacity:1}50%{opacity:.2}}
@keyframes fadeUp {from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ SPLASH â”€â”€ */
#splash{position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;
  align-items:center;justify-content:center;color:#fff;overflow:hidden;
  background:linear-gradient(135deg,var(--bl) 0%,var(--bl-dk) 55%,#001d3d 100%)}
#splash::before{content:'';position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(ellipse at 25% 55%,rgba(255,107,0,.2),transparent 55%),
             radial-gradient(ellipse at 78% 18%,rgba(0,120,255,.3),transparent 50%)}
.sp-wh{font-size:84px;animation:spin 11s linear infinite;z-index:1;margin-bottom:16px;
  filter:drop-shadow(0 0 22px rgba(255,184,0,.45))}
.sp-br{font-family:var(--fh);font-size:44px;font-weight:800;z-index:1;letter-spacing:.3px}
.sp-br em{color:#FFB800;font-style:normal}
.sp-su{font-size:13px;opacity:.5;margin-bottom:46px;z-index:1;letter-spacing:.3px}
.sp-bw{width:230px;height:5px;background:rgba(255,255,255,.1);border-radius:5px;overflow:hidden;z-index:1}
.sp-bf{height:100%;background:linear-gradient(90deg,#FFB800,var(--sf));transition:width .25s ease}
.sp-mg{font-size:13px;opacity:.4;margin-top:16px;animation:pulse 1.5s infinite;z-index:1}

/* â”€â”€ DB SETUP BLOCKER â”€â”€ */
#db-setup{position:fixed;inset:0;z-index:9998;background:linear-gradient(135deg,#0a0f1a,#0d2137);
  display:none;align-items:center;justify-content:center;padding:20px;color:#fff}
#db-setup.on{display:flex}
.dbs-card{background:#fff;color:var(--tx);border-radius:22px;max-width:580px;width:100%;
  padding:36px 32px;box-shadow:var(--sh2);animation:fadeUp .3s ease}
.dbs-card h2{font-family:var(--fh);font-size:24px;font-weight:800;color:var(--nv);margin-bottom:6px}
.dbs-card p{font-size:14px;color:var(--mt);line-height:1.7;margin-bottom:18px}
.step-list{display:flex;flex-direction:column;gap:12px;margin-bottom:22px}
.step{display:flex;gap:12px;align-items:flex-start;font-size:14px;line-height:1.6}
.step-n{width:28px;height:28px;background:var(--bl);color:#fff;border-radius:50%;display:flex;
  align-items:center;justify-content:center;font-weight:800;font-size:13px;flex-shrink:0;margin-top:1px}
.step a{color:var(--bl);font-weight:700}
.dbs-hint{background:var(--bl-lt);border:1.5px solid var(--bl);border-radius:10px;
  padding:12px 14px;font-size:13px;line-height:1.65;margin-bottom:18px;color:var(--bl-dk)}
.dbs-hint code{background:#dbeafe;padding:2px 6px;border-radius:4px;font-family:monospace;font-size:12px}
.btn-dbs{width:100%;padding:14px;background:linear-gradient(135deg,var(--bl),var(--bl-dk));
  color:#fff;border:none;border-radius:11px;font-family:var(--fh);font-size:17px;
  font-weight:700;cursor:pointer;transition:.2s}
.btn-dbs:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,87,168,.35)}

/* â”€â”€ COMMON BUTTONS â”€â”€ */
.btn{padding:10px 18px;border:none;border-radius:9px;font-family:var(--fb);font-size:13px;
  font-weight:600;cursor:pointer;transition:.18s;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
.btn:hover{transform:translateY(-1px)}.btn:active{transform:none}
.b-prim{background:var(--gn);color:#fff}.b-prim:hover{background:#0f6b06}
.b-blue{background:var(--bl);color:#fff}.b-blue:hover{background:var(--bl-dk)}
.b-mark{background:var(--pur);color:#fff}.b-mark:hover{background:#9333EA}
.b-gray{background:#6B7280;color:#fff}.b-gray:hover{background:#4B5563}
.b-out{background:#fff;color:var(--bl);border:2px solid var(--bl)}.b-out:hover{background:var(--bl-lt)}
.b-sub{background:linear-gradient(135deg,#EF4444,#DC2626);color:#fff;font-weight:700;font-size:14px;padding:10px 22px}
.b-sub:hover{box-shadow:0 4px 14px rgba(239,68,68,.4)}
.b-sf{background:linear-gradient(135deg,var(--sf),var(--sf-dk));color:#fff}
.b-sf:hover{box-shadow:0 4px 14px rgba(255,107,0,.4)}
.b-danger{background:#EF4444;color:#fff}.b-danger:hover{background:#DC2626}

/* â”€â”€ FOOTER â”€â”€ */
.ft{background:var(--nv);color:rgba(255,255,255,.38);text-align:center;padding:14px 20px;
  font-size:11.5px;line-height:2.1;border-radius:14px;width:100%;flex-shrink:0}
.ft-br{font-family:var(--fh);font-size:15px;font-weight:800;color:#fff;display:block;margin-bottom:1px}
.ft-br em{color:#FFB800;font-style:normal}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:86px;left:50%;transform:translateX(-50%) translateY(8px);
  background:var(--nv);color:#fff;padding:11px 22px;border-radius:24px;font-size:13px;
  font-weight:600;z-index:700;opacity:0;pointer-events:none;transition:all .28s;
  white-space:nowrap;max-width:92vw;text-align:center}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

/* â”€â”€ MODAL â”€â”€ */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:600;
  align-items:center;justify-content:center;padding:20px}
.mo.on{display:flex}
.md{background:#fff;border-radius:18px;padding:30px;max-width:400px;width:100%;
  box-shadow:0 24px 50px rgba(0,0,0,.35);animation:fadeUp .25s ease}
.md h3{font-family:var(--fh);font-size:21px;font-weight:800;margin-bottom:8px;color:var(--bl)}
.md p{font-size:14px;color:var(--mt);line-height:1.65;margin-bottom:16px}
.md-st{background:var(--bg);border-radius:10px;padding:14px;margin-bottom:20px;
  display:grid;grid-template-columns:1fr 1fr;gap:10px}
.ms{font-size:13px;color:var(--mt)}.ms span{font-weight:800;color:var(--bl)}
.md-bt{display:flex;gap:10px}.md-bt .btn{flex:1;justify-content:center;padding:13px}

/* â”€â”€ REFRESH GUARD â”€â”€ */
#rg{position:fixed;inset:0;background:rgba(5,15,30,.96);display:none;
  align-items:center;justify-content:center;z-index:8000;padding:20px}
#rg.on{display:flex}
.rg-c{background:#fff;border-radius:22px;padding:36px 30px;max-width:460px;width:100%;
  text-align:center;box-shadow:0 24px 60px rgba(0,0,0,.5);animation:fadeUp .3s ease}
.rg-ic{font-size:50px;margin-bottom:10px}
.rg-ti{font-family:var(--fh);font-size:22px;font-weight:800;color:var(--bl);margin-bottom:8px}
.rg-de{font-size:14px;color:var(--mt);line-height:1.7;margin-bottom:22px}
.rg-sg{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:22px}
.rg-si{background:var(--bg);border-radius:10px;padding:12px 6px}
.rg-sv{font-family:var(--fh);font-size:22px;font-weight:800;color:var(--bl)}
.rg-sl{font-size:11px;color:var(--mt);margin-top:2px}
.rg-bt{display:flex;flex-direction:column;gap:10px}
.btn-rg{padding:13px;border:none;border-radius:10px;font-family:var(--fh);font-size:15px;font-weight:700;cursor:pointer;transition:.2s}
.btn-resume{background:var(--gn);color:#fff}.btn-resume:hover{background:#0f6b06;transform:translateY(-1px)}
.btn-fresh{background:var(--bg);color:var(--mt);border:2px solid var(--bd)}.btn-fresh:hover{background:var(--bd)}

/* â•â•â•â•â•â•â•â•â•â•â•â• LANDING â•â•â•â•â•â•â•â•â•â•â•â• */
#landing{background:linear-gradient(135deg,var(--bl) 0%,var(--bl-dk) 55%,var(--sf) 100%);
  align-items:center;justify-content:center;padding:24px;min-height:100vh}
.lc-out{width:100%;max-width:530px;display:flex;flex-direction:column;align-items:center;gap:16px}
.lc{background:#fff;border-radius:24px;padding:38px 34px;width:100%;box-shadow:var(--sh2);text-align:center;animation:fadeUp .4s ease}
.lc-wh{font-size:58px;animation:spin 14s linear infinite;display:block;margin-bottom:14px}
.lc-br{font-family:var(--fh);font-size:30px;font-weight:800;color:var(--bl);line-height:1.1}
.lc-br em{color:var(--sf);font-style:normal}
.lc-su{font-size:13px;color:var(--sf);font-weight:600;letter-spacing:.4px;margin:4px 0 20px}
.ig{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
.ib{background:var(--bg);border-radius:10px;padding:12px;text-align:center}
.ib-v{font-family:var(--fh);font-size:24px;font-weight:800;color:var(--bl)}
.ib-l{font-size:11px;color:var(--mt);margin-top:1px}
.hdv{height:2px;background:linear-gradient(90deg,var(--sf),var(--bl));border-radius:2px;margin:14px 0}
.fg{margin-bottom:12px;text-align:left}
.fg label{display:block;font-size:11px;font-weight:700;color:var(--mt);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
.fg input{width:100%;padding:12px 14px;border:2px solid var(--bd);border-radius:10px;
  font-family:var(--fb);font-size:15px;outline:none;transition:.2s;background:#fff;color:var(--tx)}
.fg input:focus{border-color:var(--bl);box-shadow:0 0 0 3px rgba(0,87,168,.1)}
.ib-box{background:var(--sf-lt);border:1.5px solid #FFB800;border-radius:10px;
  padding:14px;text-align:left;margin-bottom:18px;font-size:13px;line-height:1.8}
.ib-box strong{color:var(--sf-dk)}
.lg-row{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:20px}
.ld{display:flex;align-items:center;gap:5px;font-size:11.5px;color:var(--mt)}
.ld-d{width:13px;height:13px;border-radius:50%;flex-shrink:0}
.btn-st{width:100%;padding:15px;background:linear-gradient(135deg,var(--sf),var(--sf-dk));
  color:#fff;border:none;border-radius:12px;font-family:var(--fh);font-size:18px;
  font-weight:700;cursor:pointer;transition:.2s;letter-spacing:.3px}
.btn-st:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(255,107,0,.4)}
.btn-st:disabled{opacity:.4;cursor:not-allowed;transform:none}
.no-q{display:none;background:#FFF3CD;border:1.5px solid #FFB800;border-radius:10px;
  padding:12px 14px;font-size:13px;color:#856404;margin-bottom:16px;text-align:left;line-height:1.6}
.no-q.on{display:block}
.admin-link{margin-top:12px;font-size:12px;color:rgba(255,255,255,.45);cursor:pointer;text-align:center;transition:.2s}
.admin-link:hover{color:rgba(255,255,255,.85)}

/* â•â•â•â•â•â•â•â•â•â•â•â• ADMIN LOGIN â•â•â•â•â•â•â•â•â•â•â•â• */
#admin-login{background:linear-gradient(135deg,var(--nv) 0%,#0d2137 100%);
  align-items:center;justify-content:center;padding:24px;min-height:100vh}
.al-wrap{width:100%;max-width:430px;display:flex;flex-direction:column;align-items:center;gap:16px}
.al-card{background:#fff;border-radius:22px;padding:38px 34px;width:100%;
  box-shadow:var(--sh2);text-align:center;animation:fadeUp .35s ease}
.al-icon{font-size:52px;margin-bottom:14px}
.al-title{font-family:var(--fh);font-size:26px;font-weight:800;color:var(--nv);margin-bottom:4px}
.al-sub{font-size:13px;color:var(--mt);margin-bottom:20px}
.al-badge{display:inline-block;background:linear-gradient(90deg,var(--bl),var(--bl-dk));
  color:#fff;font-size:11px;font-weight:700;padding:3px 14px;border-radius:20px;letter-spacing:.5px;margin-bottom:20px}
.setup-box{background:var(--gn-lt);border:1.5px solid var(--gn);border-radius:10px;
  padding:12px;font-size:13px;color:#1b5e20;margin-bottom:16px;text-align:left;line-height:1.65;display:none}
.al-hint{background:var(--bl-lt);border-left:3px solid var(--bl);border-radius:0 8px 8px 0;
  padding:10px 12px;font-size:13px;color:var(--bl-dk);margin-bottom:18px;text-align:left;line-height:1.6}
.pw-wrap{position:relative;margin-bottom:6px}
.pw-wrap input{width:100%;padding:13px 44px 13px 14px;border:2px solid var(--bd);border-radius:10px;
  font-family:var(--fb);font-size:16px;outline:none;transition:.2s;background:#fff;letter-spacing:2px}
.pw-wrap input:focus{border-color:var(--bl);box-shadow:0 0 0 3px rgba(0,87,168,.1)}
.pw-eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;
  border:none;cursor:pointer;font-size:18px;color:var(--mt);padding:4px}
.al-err{font-size:13px;color:#EF4444;margin-bottom:12px;min-height:18px;font-weight:600}
.btn-al{width:100%;padding:14px;background:linear-gradient(135deg,var(--nv),var(--bl-dk));
  color:#fff;border:none;border-radius:11px;font-family:var(--fh);font-size:17px;font-weight:700;cursor:pointer;transition:.2s;margin-top:4px}
.btn-al:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(10,22,40,.4)}
.btn-al:disabled{opacity:.5;cursor:not-allowed;transform:none}
.al-back{margin-top:16px;font-size:13px;color:var(--mt);cursor:pointer;transition:.2s}
.al-back:hover{color:var(--bl)}

/* â•â•â•â•â•â•â•â•â•â•â•â• ADMIN PANEL â•â•â•â•â•â•â•â•â•â•â•â• */
#admin-panel{background:var(--bg);min-height:100vh}
.ap-hdr{background:linear-gradient(90deg,var(--nv),var(--bl-dk));color:#fff;padding:0 24px;
  height:60px;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:100;box-shadow:0 3px 12px rgba(0,0,0,.3);flex-shrink:0}
.ap-logo{font-family:var(--fh);font-size:17px;font-weight:800}
.ap-logo em{color:#FFB800;font-style:normal}
.ap-logo span{opacity:.55;font-size:12px;font-weight:400;margin-left:8px;letter-spacing:.3px}
.ap-hdr-rt{display:flex;align-items:center;gap:10px}
.ap-body{max-width:1200px;margin:0 auto;padding:24px;display:flex;flex-direction:column;gap:24px}
.ap-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
@media(max-width:860px){.ap-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:480px){.ap-grid{grid-template-columns:1fr 1fr}}
.ap-stat{background:#fff;border-radius:var(--r, 14px);padding:20px;box-shadow:var(--sh);border-top:4px solid var(--bl)}
.ap-stat.g{border-top-color:var(--gn)}.ap-stat.o{border-top-color:var(--sf)}.ap-stat.p{border-top-color:var(--pur)}
.ap-sv{font-family:var(--fh);font-size:32px;font-weight:800;color:var(--tx);line-height:1}
.ap-sl{font-size:12px;color:var(--mt);font-weight:600;margin-top:6px;text-transform:uppercase;letter-spacing:.4px}
.ap-card{background:#fff;border-radius:14px;padding:24px;box-shadow:var(--sh)}
.ap-card-hd{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:12px}
.ap-ct{font-family:var(--fh);font-size:18px;font-weight:800;color:var(--nv)}
.ap-cs{font-size:12px;color:var(--mt);margin-top:3px}
.last-upd{display:none;background:var(--gn-lt);border:1px solid var(--gn);border-radius:8px;
  padding:6px 12px;font-size:12px;font-weight:600;color:var(--gn);align-items:center;gap:6px}
.last-upd.on{display:inline-flex}

/* Question editor */
.q-status{display:flex;align-items:center;gap:16px;background:var(--bg);border-radius:10px;
  padding:13px 16px;margin-bottom:16px;flex-wrap:wrap;border:1px solid var(--bd)}
.qs-item{font-size:13px;color:var(--mt)}.qs-item b{color:var(--tx);font-weight:700}
.qs-item.ok b{color:var(--gn)}
.q-area{width:100%;min-height:260px;max-height:380px;padding:14px;border:2px solid var(--bd);
  border-radius:10px;font-family:'Courier New',monospace;font-size:13px;line-height:1.6;
  outline:none;resize:vertical;transition:.2s;background:#FAFAFA;color:var(--tx)}
.q-area:focus{border-color:var(--bl);background:#fff}
.q-area.ok{border-color:var(--gn)}.q-area.bad{border-color:#EF4444}
.q-msg{font-size:12px;margin-top:6px;min-height:18px;font-weight:600}
.q-msg.ok{color:var(--gn)}.q-msg.bad{color:#EF4444}
.q-acts{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}

/* Score table */
.tbl-bar{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.srch{padding:9px 14px;border:2px solid var(--bd);border-radius:9px;font-family:var(--fb);
  font-size:13px;outline:none;transition:.2s;width:210px}
.srch:focus{border-color:var(--bl)}
.srt{padding:9px 12px;border:2px solid var(--bd);border-radius:9px;font-family:var(--fb);
  font-size:13px;outline:none;background:#fff;cursor:pointer}
.tbl-wrap{overflow-x:auto;border-radius:10px;border:1px solid var(--bd)}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:10px 12px;background:var(--bg);font-weight:700;font-size:11px;
  text-transform:uppercase;letter-spacing:.5px;color:var(--mt);border-bottom:2px solid var(--bd)}
td{padding:11px 12px;border-bottom:1px solid var(--bd);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:#f9fafb}
.sb{display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:700}
.sb-hi{background:#D1FAE5;color:#065F46}.sb-md{background:#FEF3C7;color:#92400E}.sb-lo{background:#FEE2E2;color:#991B1B}
.tbl-empty{text-align:center;padding:32px;color:var(--mt);font-size:14px}

/* Settings */
.set-row{display:flex;align-items:center;justify-content:space-between;
  padding:14px 0;border-bottom:1px solid var(--bd);flex-wrap:wrap;gap:10px}
.set-row:last-child{border-bottom:none}
.set-lbl{font-size:14px;font-weight:600;color:var(--tx)}
.set-dsc{font-size:12px;color:var(--mt);margin-top:2px}
.set-inp{padding:9px 12px;border:2px solid var(--bd);border-radius:8px;font-family:var(--fb);
  font-size:14px;outline:none;transition:.2s;width:80px;text-align:center}
.set-inp:focus{border-color:var(--bl)}
.tog{width:46px;height:26px;background:var(--bd);border-radius:13px;cursor:pointer;
  position:relative;transition:.2s;border:none;flex-shrink:0}
.tog.on{background:var(--gn)}
.tog::after{content:'';position:absolute;width:20px;height:20px;background:#fff;
  border-radius:50%;top:3px;left:3px;transition:.2s;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.tog.on::after{left:23px}

/* â•â•â•â•â•â•â•â•â•â•â•â• TEST SCREEN â•â•â•â•â•â•â•â•â•â•â•â• */
.th{background:linear-gradient(90deg,var(--bl),var(--bl-dk));color:#fff;padding:0 20px;
  height:60px;display:flex;align-items:center;justify-content:space-between;gap:14px;
  position:sticky;top:0;z-index:100;box-shadow:0 3px 12px rgba(0,0,0,.28);flex-shrink:0}
.th-logo{font-family:var(--fh);font-size:17px;font-weight:800;white-space:nowrap}
.th-logo em{color:#FFB800;font-style:normal}
.th-ctr{flex:1;display:flex;justify-content:center}
.tp{display:flex;align-items:center;gap:9px;background:rgba(255,255,255,.1);
  padding:7px 18px;border-radius:24px;border:1px solid rgba(255,255,255,.18)}
.tp-lbl{font-size:10px;opacity:.65;font-weight:700;letter-spacing:.6px}
.tp-v{font-family:var(--fh);font-size:20px;font-weight:800;letter-spacing:2px;min-width:90px;text-align:center}
.tp-v.warn{color:#FFB800;animation:blink .9s infinite}
.tp-v.danger{color:#FF4444;animation:blink .45s infinite}
.th-rt{display:flex;align-items:center;gap:10px;flex-shrink:0}
.th-cand{text-align:right}
.th-name{font-size:13px;font-weight:700}
.th-roll{font-size:11px;opacity:.6}
.btn-fs{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);
  color:#fff;font-size:16px;cursor:pointer;padding:6px 10px;border-radius:8px;transition:.2s}
.btn-fs:hover{background:rgba(255,255,255,.2)}
.rv-ban{background:var(--pur);color:#fff;text-align:center;padding:8px;
  font-size:13px;font-weight:700;display:none;flex-shrink:0}
.rv-ban.on{display:block}
.pb-w{height:5px;background:rgba(0,87,168,.12);flex-shrink:0}
.pb{height:100%;background:linear-gradient(90deg,#FFB800,var(--sf));transition:width .35s;border-radius:0 3px 3px 0}
.st-wrap{display:flex;overflow-x:auto;background:#fff;border-bottom:2px solid var(--bd);
  scrollbar-width:none;padding:0 12px;flex-shrink:0;box-shadow:0 1px 5px rgba(0,0,0,.05)}
.st-wrap::-webkit-scrollbar{display:none}
.st{padding:11px 20px;font-size:13px;font-weight:600;cursor:pointer;
  border-bottom:3px solid transparent;white-space:nowrap;transition:.2s;
  color:var(--mt);flex-shrink:0;border-radius:6px 6px 0 0;margin-top:4px}
.st.on{color:var(--bl);border-bottom-color:var(--bl);background:var(--bl-lt)}
.st:hover:not(.on){color:var(--bl);background:#f4f8ff}
#test{background:var(--bg);min-height:100vh;overflow:hidden;max-height:100vh}
.tb{display:flex;flex:1;overflow:hidden;height:calc(100vh - 60px - 5px - 46px - 56px)}
.qp{flex:1;overflow-y:auto;padding:22px 26px;display:flex;flex-direction:column;gap:20px}
.qp::-webkit-scrollbar{width:5px}.qp::-webkit-scrollbar-thumb{background:var(--bd);border-radius:10px}
.q-meta{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.q-badge{font-family:var(--fh);font-size:13px;font-weight:700;background:var(--bl);
  color:#fff;padding:5px 16px;border-radius:20px}
.q-marks{display:flex;gap:8px;align-items:center}
.mk-ok{font-size:12px;background:var(--gn-lt);color:var(--gn);font-weight:700;
  padding:4px 12px;border-radius:12px;border:1px solid var(--gn)}
.mk-no{font-size:12px;background:#fff0f0;color:var(--c-no);font-weight:700;
  padding:4px 12px;border-radius:12px;border:1px solid var(--c-no);display:none}
.mk-no.on{display:inline-block}
.qc{background:#fff;border-radius:18px;padding:28px 32px;box-shadow:var(--sh);position:relative;overflow:hidden}
.qc::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--bl),var(--sf))}
.q-tx{font-size:17px;line-height:1.78;font-weight:500;margin-bottom:24px;color:var(--tx)}
.q-im{max-width:100%;border-radius:10px;margin-bottom:16px;border:1px solid var(--bd)}
.opts{display:grid;gap:10px;grid-template-columns:1fr}
@media(min-width:960px){.opts{grid-template-columns:1fr 1fr}}
.opt{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;border:2px solid var(--bd);
  border-radius:12px;cursor:pointer;transition:.18s;background:#fff;font-size:15px;text-align:left;width:100%}
.opt:hover{border-color:var(--bl);background:var(--bl-lt);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,87,168,.1)}
.opt.sel{border-color:var(--bl);background:var(--bl-lt);box-shadow:0 0 0 1px var(--bl)}
.opt.cor{border-color:var(--gn);background:var(--gn-lt)!important;box-shadow:0 0 0 1px var(--gn)}
.opt.inc{border-color:var(--c-no);background:#fff0f0!important;box-shadow:0 0 0 1px var(--c-no)}
.opt-k{width:30px;height:30px;border-radius:50%;background:var(--bg);display:flex;
  align-items:center;justify-content:center;font-weight:800;font-size:13px;flex-shrink:0;transition:.18s;font-family:var(--fh)}
.opt.sel .opt-k{background:var(--bl);color:#fff}
.opt.cor .opt-k{background:var(--gn);color:#fff}
.opt.inc .opt-k{background:var(--c-no);color:#fff}
.opt-tx{line-height:1.55;flex:1;padding-top:2px}
.ab{display:flex;align-items:center;gap:10px;background:#fff;padding:10px 20px;
  border-top:2px solid var(--bd);flex-shrink:0;flex-wrap:wrap;min-height:56px;box-shadow:0 -2px 8px rgba(0,0,0,.04)}
.ab-sp{flex:1}
.sidebar{width:300px;background:#fff;border-left:2px solid var(--bd);overflow-y:auto;display:flex;flex-direction:column;flex-shrink:0}
.sidebar::-webkit-scrollbar{width:4px}.sidebar::-webkit-scrollbar-thumb{background:var(--bd);border-radius:10px}
.sb-hd{padding:14px 16px;border-bottom:2px solid var(--bd);font-family:var(--fh);font-weight:800;font-size:14px;color:var(--bl);background:var(--bl-lt)}
.sb-ci{padding:12px 16px;background:linear-gradient(90deg,#e3f0ff,#fff);border-bottom:1px solid var(--bd)}
.sb-nm{font-weight:800;font-size:14px;color:var(--bl)}.sb-rl{font-size:11px;color:var(--mt);margin-top:1px}
.sg{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--bd)}
.sc{padding:12px 8px;text-align:center;border-right:1px solid var(--bd);border-bottom:1px solid var(--bd)}
.sc:nth-child(even){border-right:none}
.sv{font-family:var(--fh);font-size:22px;font-weight:800}
.sl{font-size:10px;color:var(--mt);margin-top:1px;font-weight:600}
.sv-a{color:var(--c-ans)}.sv-n{color:var(--c-no)}.sv-m{color:var(--pur)}.sv-ma{color:var(--amb)}
.qg-sec{padding:14px 16px}.qg-ttl{font-size:11px;font-weight:800;color:var(--mt);margin-bottom:10px;text-transform:uppercase;letter-spacing:.6px}
.qgrid{display:grid;grid-template-columns:repeat(6,1fr);gap:5px}
.qb{width:100%;aspect-ratio:1;border:none;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;transition:.15s;background:var(--c-nv);color:#fff;font-family:var(--fb)}
.qb:hover{transform:scale(1.12)}.qb.cur{outline:3px solid var(--bl);outline-offset:2px}
.qb.ans{background:var(--c-ans)}.qb.no{background:var(--c-no)}
.qb.mk{background:var(--pur)}.qb.mka{background:var(--amb)}
.sb-lg{padding:12px 16px;border-top:1px solid var(--bd);display:flex;flex-direction:column;gap:7px}
.sbl{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--mt)}
.sbl-b{width:20px;height:20px;border-radius:5px;flex-shrink:0}
.sb-sub{padding:14px 16px;border-top:1px solid var(--bd);margin-top:auto}
.mob-tog{display:none;position:fixed;bottom:76px;right:16px;z-index:200;background:var(--bl);
  color:#fff;border:none;border-radius:50%;width:52px;height:52px;font-size:22px;cursor:pointer;
  box-shadow:0 4px 16px rgba(0,0,0,.35);align-items:center;justify-content:center}
.sb-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:150}
@media(max-width:1024px){
  .sidebar{position:fixed;right:-310px;top:0;bottom:0;z-index:160;transition:right .3s;box-shadow:-6px 0 24px rgba(0,0,0,.2)}
  .sidebar.open{right:0}.mob-tog{display:flex}.sb-ov.on{display:block}
}
@media(max-width:640px){
  .qp{padding:14px}.qc{padding:18px}.q-tx{font-size:15px}
  .btn{padding:9px 12px;font-size:12px}.st{padding:9px 13px;font-size:12px}.th-cand{display:none}
}
/* â”€â”€ RESULT â”€â”€ */
#result{background:linear-gradient(135deg,var(--bl),var(--bl-dk));align-items:center;justify-content:flex-start;padding:24px;overflow-y:auto;min-height:100vh}
.rc-out{display:flex;flex-direction:column;align-items:center;gap:16px;width:100%;max-width:660px;margin:0 auto}
.rc{background:#fff;border-radius:24px;width:100%;box-shadow:var(--sh2);overflow:hidden;animation:fadeUp .4s ease}
.rc-hd{background:linear-gradient(135deg,var(--sf),var(--sf-dk));padding:28px;text-align:center;color:#fff}
.rc-hd h2{font-family:var(--fh);font-size:26px;font-weight:800;margin-bottom:4px}
.rc-hd p{opacity:.85;font-size:14px}
.rc-sa{padding:28px 28px 0;display:flex;gap:28px;align-items:center;justify-content:center;flex-wrap:wrap}
.sr-w{width:150px;height:150px;position:relative;flex-shrink:0}
.sr-svg{width:150px;height:150px;transform:rotate(-90deg)}
.sr-bg{fill:none;stroke:#f0f0f0;stroke-width:13}
.sr-f{fill:none;stroke-width:13;stroke-linecap:round;transition:stroke-dashoffset 1.6s cubic-bezier(.4,0,.2,1)}
.sr-tx{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.sr-pct{font-family:var(--fh);font-size:34px;font-weight:800;color:var(--bl);line-height:1}
.sr-lb{font-size:11px;color:var(--mt);margin-top:2px}
.sd{display:flex;flex-direction:column;gap:9px}
.sd-tot{font-family:var(--fh);font-size:28px;font-weight:800;color:var(--tx)}
.sd-row{font-size:13px;color:var(--mt)}.sd-row b{color:var(--bl)}
.rc-st{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--bd);margin-top:20px;border-top:1px solid var(--bd);border-bottom:1px solid var(--bd)}
.rs{background:#fff;padding:18px 8px;text-align:center}
.rs .rv{font-family:var(--fh);font-size:24px;font-weight:800}
.rs .rl{font-size:11px;color:var(--mt);margin-top:2px;font-weight:600}
.rs-c .rv{color:var(--gn)}.rs-w .rv{color:var(--c-no)}.rs-s .rv{color:var(--mt)}
.rc-msg{padding:16px 28px;text-align:center;font-size:15px;font-weight:600;color:var(--mt);background:var(--bg)}
.rc-act{padding:24px;display:flex;gap:12px}
.rc-btn{flex:1;padding:14px;border:none;border-radius:11px;font-family:var(--fh);font-size:16px;font-weight:700;cursor:pointer;transition:.2s}
.rc-btn:hover{transform:translateY(-2px)}
.rcb-rv{background:var(--bl);color:#fff}.rcb-rv:hover{background:var(--bl-dk)}
.rcb-rs{background:var(--gn);color:#fff}.rcb-rs:hover{background:#0f6b06}
</style>
</head>
<body>

<!-- â•â•â• SPLASH (4 seconds) â•â•â• -->
<div id="splash">
  <div class="sp-wh">â˜¸ï¸</div>
  <div class="sp-br">Nishu<em>Abhyasi</em></div>
  <div class="sp-su">Bihar B.Ed CET â€“ Online Mock Test Portal</div>
  <div class="sp-bw"><div class="sp-bf" id="sp-bf" style="width:0%"></div></div>
  <div class="sp-mg" id="sp-mg">Connecting to databaseâ€¦</div>
</div>

<!-- â•â•â• FIREBASE SETUP GUIDE (shown if config not filled in) â•â•â• -->
<div id="db-setup">
  <div class="dbs-card">
    <h2>ğŸ”§ One-Time Firebase Setup Required</h2>
    <p>NishuAbhyasi uses <strong>Firebase Firestore</strong> as its free database. This is a 5-minute, one-time setup â€” after this everything works permanently, even after refresh.</p>
    <div class="step-list">
      <div class="step"><div class="step-n">1</div><div>Go to <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a> â†’ <strong>Add project</strong> â†’ Name it <em>nishuabhyasi</em> â†’ Create</div></div>
      <div class="step"><div class="step-n">2</div><div>In left menu: <strong>Build â†’ Firestore Database â†’ Create database â†’ Start in Test mode</strong> â†’ Choose a region â†’ Done</div></div>
      <div class="step"><div class="step-n">3</div><div>Left menu: <strong>Project Settings</strong> (gear icon) â†’ <strong>Your apps</strong> â†’ click <strong>&lt;/&gt; Web</strong> â†’ Register app â†’ Copy the <code>firebaseConfig</code> object</div></div>
      <div class="step"><div class="step-n">4</div><div>Open <code>index.html</code> in a text editor â†’ Find the <code>FIREBASE_CONFIG</code> object at the top of the &lt;script type="module"&gt; block â†’ Paste your values</div></div>
      <div class="step"><div class="step-n">5</div><div>Save the file, re-upload to GitHub Pages, and <strong>refresh</strong> â€” setup complete! âœ…</div></div>
    </div>
    <div class="dbs-hint">ğŸ’¡ <strong>Firestore free tier</strong> gives you 50,000 reads + 20,000 writes per day â€” more than enough for hundreds of students. No credit card required.</div>
    <button class="btn-dbs" onclick="location.reload()">ğŸ”„ I've Updated the Config â€” Reload</button>
  </div>
</div>

<!-- â•â•â• REFRESH GUARD â•â•â• -->
<div id="rg">
  <div class="rg-c">
    <div class="rg-ic">âš ï¸</div>
    <div class="rg-ti">Test Was Interrupted</div>
    <div class="rg-de">Your session was interrupted. All your answers are <strong>saved locally</strong>. Resume exactly where you left off.</div>
    <div class="rg-sg">
      <div class="rg-si"><div class="rg-sv" id="rg-ans">â€”</div><div class="rg-sl">Answered</div></div>
      <div class="rg-si"><div class="rg-sv" id="rg-tim">â€”</div><div class="rg-sl">Time Left</div></div>
      <div class="rg-si"><div class="rg-sv" id="rg-q">â€”</div><div class="rg-sl">Last Q.</div></div>
    </div>
    <div class="rg-bt">
      <button class="btn-rg btn-resume" onclick="doResume()">â–¶ Resume My Test</button>
      <button class="btn-rg btn-fresh" onclick="doFresh()">ğŸ—‘ Discard & Start Fresh</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• SCREEN: LANDING â•â•â•â•â•â•â• -->
<div id="landing" class="screen active">
  <div class="lc-out">
    <div class="lc">
      <span class="lc-wh">â˜¸ï¸</span>
      <div class="lc-br">Nishu<em>Abhyasi</em></div>
      <div class="lc-su">Bihar B.Ed CET â€“ Online Mock Test Portal</div>
      <div class="ig">
        <div class="ib"><div class="ib-v" id="info-tot">â€”</div><div class="ib-l">Questions</div></div>
        <div class="ib"><div class="ib-v" id="info-min">â€”</div><div class="ib-l">Duration (min)</div></div>
        <div class="ib"><div class="ib-v">+1</div><div class="ib-l">Per Correct</div></div>
        <div class="ib"><div class="ib-v" id="info-neg">0</div><div class="ib-l">Negative Mark</div></div>
      </div>
      <div class="hdv"></div>
      <div class="no-q" id="no-q">âš ï¸ <strong>No questions uploaded yet.</strong> Admin needs to add questions before the test can begin.</div>
      <div class="fg"><label>Your Full Name</label><input type="text" id="c-name" placeholder="Enter your full name"/></div>
      <div class="fg"><label>Roll Number (Optional)</label><input type="text" id="c-roll" placeholder="e.g. BED2025001"/></div>
      <div class="ib-box">
        <strong>ğŸ“‹ Instructions:</strong><br/>
        1. All questions are MCQ â€” one correct answer only.<br/>
        2. Each correct answer = <strong>+1 mark</strong>. Do not refresh the page.<br/>
        3. Mark questions for review and return to them.<br/>
        4. Click <strong>Submit Test</strong> when done or time expires.
      </div>
      <div class="lg-row">
        <div class="ld"><div class="ld-d" style="background:var(--c-ans)"></div>Answered</div>
        <div class="ld"><div class="ld-d" style="background:var(--c-no)"></div>Not Answered</div>
        <div class="ld"><div class="ld-d" style="background:var(--pur)"></div>Marked</div>
        <div class="ld"><div class="ld-d" style="background:var(--amb)"></div>Marked+Ans</div>
        <div class="ld"><div class="ld-d" style="background:var(--c-nv)"></div>Not Visited</div>
      </div>
      <button class="btn-st" id="btn-st" onclick="startTest()">âœ… I Have Read Instructions â€” Start Test</button>
    </div>
    <div class="admin-link" onclick="goAdmin()">ğŸ” Admin Panel</div>
    <footer class="ft">
      <span class="ft-br">Nishu<em>Abhyasi</em></span>
      An app by <strong style="color:#fff">Yashwant</strong> &nbsp;|&nbsp; Â© 2025 &nbsp;|&nbsp; Bihar B.Ed CET Prep
    </footer>
  </div>
</div>

<!-- â•â•â•â•â•â•â• SCREEN: ADMIN LOGIN â•â•â•â•â•â•â• -->
<div id="admin-login" class="screen">
  <div style="background:linear-gradient(135deg,var(--nv),#0d2137);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;flex-direction:column;gap:16px">
    <div class="al-wrap">
      <div class="al-card">
        <div class="al-icon">ğŸ›¡ï¸</div>
        <div class="al-title">Admin Panel</div>
        <div class="al-sub">NishuAbhyasi â€” Secure Access</div>
        <div class="al-badge">ADMINISTRATOR ONLY</div>
        <div class="setup-box" id="setup-box">
          ğŸ”‘ <strong>First-time setup:</strong> Create your admin password. It is stored as a SHA-256 hash in Firebase â€” never as plain text.
        </div>
        <div class="al-hint" id="al-hint">Enter your admin password to access the control panel.</div>
        <div class="pw-wrap">
          <input type="password" id="al-pw" placeholder="Admin password" onkeydown="if(event.key==='Enter')doLogin()"/>
          <button class="pw-eye" onclick="toggleEye()">ğŸ‘</button>
        </div>
        <div class="al-err" id="al-err"></div>
        <button class="btn-al" id="al-btn" onclick="doLogin()">ğŸ”“ Login to Admin Panel</button>
        <div class="al-back" onclick="showScreen('landing')">â† Back to Student Portal</div>
      </div>
      <footer class="ft" style="max-width:430px">
        <span class="ft-br">Nishu<em>Abhyasi</em></span>
        An app by <strong style="color:#fff">Yashwant</strong> &nbsp;|&nbsp; Â© 2025
      </footer>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• SCREEN: ADMIN PANEL â•â•â•â•â•â•â• -->
<div id="admin-panel" class="screen">
  <div class="ap-hdr">
    <div class="ap-logo">Nishu<em>Abhyasi</em> <span>Admin Panel</span></div>
    <div class="ap-hdr-rt">
      <button class="btn b-out" style="font-size:12px;padding:7px 14px" onclick="showScreen('landing')">â† Student Portal</button>
      <button class="btn b-danger" style="font-size:12px;padding:7px 14px" onclick="adminOut()">Logout</button>
    </div>
  </div>
  <div class="ap-body">

    <!-- Stats -->
    <div class="ap-grid">
      <div class="ap-stat">   <div class="ap-sv" id="ap-nq">â€”</div><div class="ap-sl">ğŸ“ Questions</div></div>
      <div class="ap-stat g"> <div class="ap-sv" id="ap-na">â€”</div><div class="ap-sl">ğŸ‘©â€ğŸ“ Total Attempts</div></div>
      <div class="ap-stat o"> <div class="ap-sv" id="ap-av">â€”</div><div class="ap-sl">ğŸ“Š Avg Score</div></div>
      <div class="ap-stat p"> <div class="ap-sv" id="ap-tp">â€”</div><div class="ap-sl">ğŸ† Top Score</div></div>
    </div>

    <!-- Questions -->
    <div class="ap-card">
      <div class="ap-card-hd">
        <div><div class="ap-ct">ğŸ“‹ Question Bank</div><div class="ap-cs">Paste JSON â†’ Save â†’ Questions go live instantly for all students</div></div>
        <div class="last-upd" id="lu"><span>âœ… Updated: </span><span id="lu-t">â€”</span></div>
      </div>
      <div class="q-status">
        <div class="qs-item ok">Loaded: <b id="qs-n">0</b> questions</div>
        <div class="qs-item">Sections: <b id="qs-s">â€”</b></div>
        <div class="qs-item" id="qs-v"></div>
      </div>
      <textarea class="q-area" id="q-area" placeholder='Paste your 120-question JSON array hereâ€¦

[
  {
    "section": "General Knowledge",
    "q": "What is the capital of Bihar?",
    "options": ["Gaya", "Muzaffarpur", "Patna", "Bhagalpur"],
    "correct": 2
  },
  ...
]' oninput="liveValidate()"></textarea>
      <div class="q-msg" id="q-msg"></div>
      <div class="q-acts">
        <button class="btn b-prim" onclick="saveQ()">ğŸ’¾ Save & Publish</button>
        <button class="btn b-out"  onclick="loadQ()">ğŸ”„ Load Current</button>
        <button class="btn b-danger" onclick="clearQ()">ğŸ—‘ Clear All</button>
      </div>
    </div>

    <!-- Scores -->
    <div class="ap-card">
      <div class="ap-card-hd">
        <div><div class="ap-ct">ğŸ‘©â€ğŸ“ Student Records</div><div class="ap-cs">All test attempts â€” synced from Firebase in real-time</div></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn b-out" style="font-size:12px;padding:7px 14px" onclick="exportCSV()">â¬‡ï¸ Export CSV</button>
          <button class="btn b-danger" style="font-size:12px;padding:7px 14px" onclick="clearScores()">ğŸ—‘ Clear All</button>
        </div>
      </div>
      <div class="tbl-bar">
        <input class="srch" id="srch" placeholder="ğŸ” Search by nameâ€¦" oninput="renderTbl()"/>
        <select class="srt" id="srt" onchange="renderTbl()">
          <option value="time">Latest First</option>
          <option value="hi">Highest Score</option>
          <option value="lo">Lowest Score</option>
          <option value="az">Name Aâ€“Z</option>
        </select>
        <button class="btn b-blue" style="font-size:12px;padding:7px 14px" onclick="refreshScores()">â†º Refresh</button>
      </div>
      <div class="tbl-wrap">
        <table><thead><tr>
          <th>#</th><th>Name</th><th>Roll No.</th><th>Score</th><th>%</th>
          <th>âœ…</th><th>âŒ</th><th>â¬œ</th><th>Date & Time</th>
        </tr></thead><tbody id="tbl-body"></tbody></table>
      </div>
    </div>

    <!-- Settings -->
    <div class="ap-card">
      <div class="ap-card-hd">
        <div><div class="ap-ct">âš™ï¸ Settings</div><div class="ap-cs">Saved to Firebase â€” applies to all future tests</div></div>
        <button class="btn b-prim" onclick="saveSettings()">ğŸ’¾ Save Settings</button>
      </div>
      <div class="set-row">
        <div><div class="set-lbl">Negative Marking</div><div class="set-dsc">Deduction per wrong answer (0 = none)</div></div>
        <input class="set-inp" id="s-neg" type="number" min="0" max="1" step="0.25" value="0"/>
      </div>
      <div class="set-row">
        <div><div class="set-lbl">Minutes Per Question</div><div class="set-dsc">Total time = questions Ã— this</div></div>
        <input class="set-inp" id="s-mpq" type="number" min="0.5" max="3" step="0.5" value="1"/>
      </div>
      <div class="set-row">
        <div><div class="set-lbl">Shuffle Questions</div><div class="set-dsc">Randomise order for each student</div></div>
        <button class="tog" id="s-shuf" onclick="togSet('s-shuf')"></button>
      </div>
      <div class="set-row">
        <div><div class="set-lbl">Show Result After Submit</div><div class="set-dsc">Display score and review page</div></div>
        <button class="tog on" id="s-res" onclick="togSet('s-res')"></button>
      </div>
      <div class="set-row" style="border-bottom:none">
        <div><div class="set-lbl">Change Admin Password</div><div class="set-dsc">Stored as a secure hash in Firebase</div></div>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="password" class="set-inp" id="s-npw" placeholder="New password" style="width:160px;text-align:left"/>
          <button class="btn b-blue" style="font-size:12px" onclick="changePw()">Update</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â• SCREEN: TEST â•â•â•â•â•â•â• -->
<div id="test" class="screen">
  <div class="th">
    <div class="th-logo">Nishu<em>Abhyasi</em></div>
    <div class="th-ctr"><div class="tp"><span class="tp-lbl">TIME LEFT</span><div class="tp-v" id="timer">02:00:00</div></div></div>
    <div class="th-rt">
      <div class="th-cand"><div class="th-name" id="hdr-name">Candidate</div><div class="th-roll" id="hdr-roll">Roll: â€”</div></div>
      <button class="btn-fs" onclick="toggleFS()">â›¶</button>
    </div>
  </div>
  <div class="rv-ban" id="rv-ban">ğŸ” REVIEW MODE â€” Correct answers highlighted in green</div>
  <div class="pb-w"><div class="pb" id="pb" style="width:0%"></div></div>
  <div class="st-wrap" id="st-wrap"></div>
  <div class="tb">
    <div class="qp">
      <div class="q-meta">
        <span class="q-badge" id="q-num">Q 1 of â€”</span>
        <div class="q-marks"><span class="mk-ok">âœ“ +1 Mark</span><span class="mk-no" id="mk-no">âœ— -<span id="neg-v">0</span></span></div>
      </div>
      <div class="qc">
        <div class="q-tx" id="q-tx">Loadingâ€¦</div>
        <img id="q-im" class="q-im" src="" alt="" style="display:none"/>
        <div class="opts" id="opts"></div>
      </div>
    </div>
    <div class="sidebar" id="sidebar">
      <div class="sb-hd">ğŸ“‹ Question Palette</div>
      <div class="sb-ci"><div class="sb-nm" id="sb-nm">â€”</div><div class="sb-rl" id="sb-rl">Roll No: â€”</div></div>
      <div class="sg">
        <div class="sc"><div class="sv sv-a" id="st-a">0</div><div class="sl">âœ… Answered</div></div>
        <div class="sc"><div class="sv sv-n" id="st-n">0</div><div class="sl">âŒ Not Answd</div></div>
        <div class="sc"><div class="sv sv-m" id="st-m">0</div><div class="sl">ğŸŸ£ Marked</div></div>
        <div class="sc"><div class="sv sv-ma" id="st-ma">0</div><div class="sl">ğŸŸ¡ Mkd+Ans</div></div>
      </div>
      <div class="qg-sec"><div class="qg-ttl">Navigator</div><div class="qgrid" id="qgrid"></div></div>
      <div class="sb-lg">
        <div class="sbl"><div class="sbl-b" style="background:var(--c-ans)"></div>Answered</div>
        <div class="sbl"><div class="sbl-b" style="background:var(--c-no)"></div>Not Answered</div>
        <div class="sbl"><div class="sbl-b" style="background:var(--pur)"></div>Marked for Review</div>
        <div class="sbl"><div class="sbl-b" style="background:var(--amb)"></div>Marked & Answered</div>
        <div class="sbl"><div class="sbl-b" style="background:var(--c-nv)"></div>Not Visited</div>
      </div>
      <div class="sb-sub"><button class="btn b-sub" style="width:100%;justify-content:center" onclick="confirmSub()">ğŸ Submit Test</button></div>
    </div>
  </div>
  <div class="ab">
    <button class="btn b-out" onclick="prevQ()">â—€ Prev</button>
    <button class="btn b-mark" onclick="markRev()">ğŸ´ Mark & Next</button>
    <button class="btn b-gray" onclick="clearR()">âœ– Clear</button>
    <div class="ab-sp"></div>
    <button class="btn b-prim" onclick="saveNxt()">Save & Next â–¶</button>
  </div>
  <button class="mob-tog" onclick="togSB()">ğŸ“‹</button>
  <div class="sb-ov" id="sb-ov" onclick="togSB()"></div>
</div>

<!-- â•â•â•â•â•â•â• SCREEN: RESULT â•â•â•â•â•â•â• -->
<div id="result" class="screen">
  <div class="rc-out">
    <div class="rc">
      <div class="rc-hd"><div style="font-size:38px;margin-bottom:6px">ğŸ“</div><h2>Test Completed!</h2><p id="res-cand">Bihar B.Ed CET</p></div>
      <div class="rc-sa">
        <div class="sr-w">
          <svg class="sr-svg" viewBox="0 0 150 150">
            <circle class="sr-bg" cx="75" cy="75" r="60"/>
            <circle class="sr-f" id="sr" cx="75" cy="75" r="60" stroke-dasharray="376.99" stroke-dashoffset="376.99" stroke="var(--sf)"/>
          </svg>
          <div class="sr-tx"><div class="sr-pct" id="res-pct">0%</div><div class="sr-lb">Score</div></div>
        </div>
        <div class="sd">
          <div class="sd-tot" id="res-sc">0 / â€”</div>
          <div class="sd-row">Correct Ã— 1 = <b id="sd-c">0</b> pts</div>
          <div class="sd-row">Wrong penalty = <b id="sd-n" style="color:var(--c-no)">0</b> pts</div>
          <div class="sd-row">Net Score: <b id="sd-net">0</b></div>
        </div>
      </div>
      <div class="rc-st">
        <div class="rs rs-c"><div class="rv" id="res-cor">0</div><div class="rl">âœ… Correct</div></div>
        <div class="rs rs-w"><div class="rv" id="res-wr">0</div><div class="rl">âŒ Wrong</div></div>
        <div class="rs rs-s"><div class="rv" id="res-sk">0</div><div class="rl">â¬œ Skipped</div></div>
      </div>
      <div class="rc-msg" id="res-msg"></div>
      <div class="rc-act">
        <button class="rc-btn rcb-rv" onclick="reviewTest()">ğŸ” Review Answers</button>
        <button class="rc-btn rcb-rs" onclick="doFresh()">ğŸ”„ New Test</button>
      </div>
    </div>
    <footer class="ft">
      <span class="ft-br">Nishu<em>Abhyasi</em></span>
      An app by <strong style="color:#fff">Yashwant</strong> &nbsp;|&nbsp; Â© 2025 &nbsp;|&nbsp; Bihar B.Ed CET Prep
    </footer>
  </div>
</div>

<!-- Submit Modal -->
<div class="mo" id="mo">
  <div class="md">
    <h3>âš ï¸ Submit Test?</h3>
    <p>Once submitted you cannot change answers. Review marked questions first.</p>
    <div class="md-st" id="md-st"></div>
    <div class="md-bt"><button class="btn b-out" onclick="closeM()">Cancel</button><button class="btn b-sub" onclick="doSubmit()">Submit Now</button></div>
  </div>
</div>
<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN SCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';
// â”€â”€ Firestore shorthand helpers (set by the module above) â”€â”€
const db  = ()=> window._db;
const fs  = ()=> window._fs;

// â”€â”€ Firestore document helpers â”€â”€
async function fbGet(docPath){
  const [col,...rest] = docPath.split('/');
  const {doc,getDoc} = fs();
  const ref = doc(db(), col, rest.join('/'));
  const snap = await getDoc(ref);
  return snap.exists() ? snap.data() : null;
}
async function fbSet(docPath, data){
  const [col,...rest] = docPath.split('/');
  const {doc,setDoc} = fs();
  await setDoc(doc(db(), col, rest.join('/')), data);
}
async function fbAdd(colPath, data){
  const {collection,addDoc} = fs();
  await addDoc(collection(db(), colPath), {...data, ts: Date.now()});
}
async function fbGetAll(colPath){
  const {collection,getDocs,query,orderBy} = fs();
  const snap = await getDocs(query(collection(db(), colPath), orderBy('ts','desc')));
  return snap.docs.map(d=>({id:d.id,...d.data()}));
}
async function fbDelAll(colPath){
  const {collection,getDocs,deleteDoc,doc} = fs();
  const snap = await getDocs(collection(db(), colPath));
  await Promise.all(snap.docs.map(d=>deleteDoc(doc(db(),colPath,d.id))));
}

// â”€â”€ SHA-256 â”€â”€
async function sha256(s){
  const b = await crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));
  return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('');
}

// â”€â”€ State â”€â”€
let Q=[], secs=[], curSec=0, curQ=0;
let ans=[], vis=[], mkd=[], tLeft=7200, tInt=null;
let isRev=false, negM=0, cName='', cRoll='', active=false;
let settings={negM:0,mpq:1,shuffle:false,showResult:true};
let allScores=[];
let adminIn=false;

const SS = 'na_v4';  // sessionStorage key for test progress only

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPLASH â€” 4 second animated intro
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MSGS = ['Connecting to databaseâ€¦','Loading question bankâ€¦','Checking your sessionâ€¦','Almost readyâ€¦','Welcome! ğŸ‰'];
function runSplash(){
  return new Promise(res=>{
    const bar=document.getElementById('sp-bf'), msg=document.getElementById('sp-mg');
    let s=0; const TOT=40;
    const iv=setInterval(()=>{
      s++; bar.style.width=(s/TOT*100)+'%';
      msg.textContent=MSGS[Math.min(Math.floor(s/TOT*MSGS.length),MSGS.length-1)];
      if(s>=TOT){ clearInterval(iv); setTimeout(res,200); }
    },100);
  });
}
function hideSplash(){
  const sp=document.getElementById('splash');
  sp.style.transition='opacity 0.5s'; sp.style.opacity='0';
  setTimeout(()=>sp.style.display='none',500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('dbready', async ()=>{
  if(!window._dbReady){
    // Check if it's a config error (placeholder still present)
    if(!window._dbError || window._dbError.includes('projectId') || FIREBASE_CONFIG.apiKey==='YOUR_API_KEY'){
      await runSplash(); hideSplash();
      document.getElementById('db-setup').classList.add('on');
    } else {
      await runSplash(); hideSplash();
      toast('âš ï¸ Firebase error: '+window._dbError);
    }
    return;
  }
  // Run splash + load data in parallel
  await Promise.all([runSplash(), bootLoad()]);
  hideSplash();
  finishBoot();
});

// Expose config for the check above
const FIREBASE_CONFIG = {apiKey: document.querySelector('script[type="module"]')?.textContent?.match(/apiKey:\s*"([^"]+)"/)?.[1] || ''};

async function bootLoad(){
  try {
    // Load settings
    const s = await fbGet('config/settings');
    if(s) Object.assign(settings, s);
    negM = settings.negM||0;
    // Load questions
    const qd = await fbGet('config/questions');
    if(qd && Array.isArray(qd.data) && qd.data.length){
      Q = settings.shuffle ? shuffle([...qd.data]) : qd.data;
    }
  } catch(e){ console.warn('Boot load error:',e.message); }
}

function finishBoot(){
  // Check for interrupted student session
  try {
    const saved = JSON.parse(sessionStorage.getItem(SS));
    if(saved && saved.ans && Q.length && saved.ans.length===Q.length){
      restoreGuard(saved); return;
    }
  } catch(e){}
  updateLanding();
}

function restoreGuard(s){
  cName=s.cName||'Candidate'; cRoll=s.cRoll||'â€”';
  curQ=s.curQ||0; tLeft=s.tLeft||Q.length*60;
  ans=s.ans; vis=s.vis; mkd=s.mkd; negM=s.negM||0;
  const a=ans.filter(x=>x!==null).length;
  const h=Math.floor(tLeft/3600),m=Math.floor((tLeft%3600)/60),s2=tLeft%60;
  document.getElementById('rg-ans').textContent=a;
  document.getElementById('rg-tim').textContent=`${p(h)}:${p(m)}:${p(s2)}`;
  document.getElementById('rg-q').textContent='#'+(curQ+1);
  document.getElementById('rg').classList.add('on');
}

function updateLanding(){
  document.getElementById('info-tot').textContent=Q.length||'â€”';
  document.getElementById('info-min').textContent=Q.length?Math.ceil(Q.length*(settings.mpq||1)):'â€”';
  document.getElementById('info-neg').textContent=settings.negM||'0';
  const noQ=document.getElementById('no-q'), btnSt=document.getElementById('btn-st');
  if(Q.length===0){ noQ.classList.add('on'); btnSt.disabled=true; }
  else { noQ.classList.remove('on'); btnSt.disabled=false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION (only test progress â€” localStorage/sessionStorage is fine here
// because it's per-device and per-student, not shared data)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveSession(){
  if(!active) return;
  try{ sessionStorage.setItem(SS,JSON.stringify({cName,cRoll,curQ,tLeft,ans,vis,mkd,negM})); }catch(e){}
}
function clearSess(){ try{sessionStorage.removeItem(SS);}catch(e){} }

function doResume(){
  document.getElementById('rg').classList.remove('on');
  buildSecs(); active=true; setHdr();
  showScreen('test'); buildTabs(); buildGrid(); renderQ(curQ); startTimer();
}
function doFresh(){
  clearSess(); clearInterval(tInt); active=false; isRev=false;
  document.getElementById('rg').classList.remove('on');
  document.getElementById('rv-ban').classList.remove('on');
  document.querySelectorAll('.ab .btn').forEach(b=>b.style.display='');
  updateLanding(); showScreen('landing');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START TEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTest(){
  if(!Q.length){ toast('No questions available.'); return; }
  cName=document.getElementById('c-name').value.trim()||'Candidate';
  cRoll=document.getElementById('c-roll').value.trim()||'â€”';
  buildSecs();
  ans=Array(Q.length).fill(null); vis=Array(Q.length).fill(false); mkd=Array(Q.length).fill(false);
  negM=settings.negM||0; isRev=false; curQ=0; curSec=0;
  tLeft=Math.round(Q.length*(settings.mpq||1)*60); active=true;
  if(negM>0){ document.getElementById('mk-no').classList.add('on'); document.getElementById('neg-v').textContent=negM; }
  setHdr(); showScreen('test'); buildTabs(); buildGrid(); renderQ(0); startTimer(); saveSession();
}
function setHdr(){
  document.getElementById('hdr-name').textContent=cName;
  document.getElementById('hdr-roll').textContent='Roll: '+cRoll;
  document.getElementById('sb-nm').textContent=cName;
  document.getElementById('sb-rl').textContent='Roll No: '+cRoll;
}
function buildSecs(){
  const m={};
  Q.forEach((q,i)=>{ const s=q.section||'General'; if(!m[s])m[s]=[]; m[s].push(i); });
  secs=Object.entries(m).map(([n,ix])=>({n,ix}));
}
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function buildTabs(){
  const w=document.getElementById('st-wrap'); w.innerHTML='';
  secs.forEach((s,i)=>{ const t=document.createElement('div'); t.className='st'+(i===0?' on':''); t.textContent=s.n; t.onclick=()=>swSec(i); w.appendChild(t); });
}
function swSec(i){ curSec=i; document.querySelectorAll('.st').forEach((t,j)=>t.classList.toggle('on',j===i)); renderQ(secs[i].ix[0]); }
function buildGrid(){
  const g=document.getElementById('qgrid'); g.innerHTML='';
  Q.forEach((_,i)=>{ const b=document.createElement('button'); b.className='qb'; b.id='qb'+i; b.textContent=i+1; b.onclick=()=>renderQ(i); g.appendChild(b); });
  refGrid();
}
function refGrid(){
  Q.forEach((_,i)=>{
    const b=document.getElementById('qb'+i); if(!b) return;
    b.className='qb';
    if(i===curQ) b.classList.add('cur');
    if(mkd[i]&&ans[i]!==null) b.classList.add('mka');
    else if(mkd[i]) b.classList.add('mk');
    else if(ans[i]!==null) b.classList.add('ans');
    else if(vis[i]) b.classList.add('no');
  });
  refStats();
}
function refStats(){
  const a=ans.filter(x=>x!==null).length,n=vis.filter((v,i)=>v&&ans[i]===null).length;
  const m=mkd.filter((v,i)=>v&&ans[i]===null).length,ma=mkd.filter((v,i)=>v&&ans[i]!==null).length;
  document.getElementById('st-a').textContent=a; document.getElementById('st-n').textContent=n;
  document.getElementById('st-m').textContent=m; document.getElementById('st-ma').textContent=ma;
  document.getElementById('pb').style.width=(a/Q.length*100)+'%';
}
function renderQ(idx){
  curQ=idx; vis[idx]=true;
  const si=secs.findIndex(s=>s.ix.includes(idx));
  if(si!==-1&&si!==curSec){ curSec=si; document.querySelectorAll('.st').forEach((t,j)=>t.classList.toggle('on',j===si)); }
  const q=Q[idx];
  document.getElementById('q-num').textContent=`Question ${idx+1} of ${Q.length}`;
  document.getElementById('q-tx').textContent=q.q||q.question||'(No question text)';
  const im=document.getElementById('q-im');
  if(q.image){im.src=q.image;im.style.display='block';}else im.style.display='none';
  const ol=document.getElementById('opts'); ol.innerHTML='';
  const ks=['A','B','C','D','E'];
  (q.options||[]).forEach((o,i)=>{
    const b=document.createElement('button'); b.className='opt';
    if(ans[idx]===i) b.classList.add('sel');
    if(isRev){ if(i===q.correct) b.classList.add('cor'); else if(ans[idx]===i) b.classList.add('inc'); }
    b.innerHTML=`<span class="opt-k">${ks[i]}</span><span class="opt-tx">${o}</span>`;
    if(!isRev) b.onclick=()=>selOpt(i);
    ol.appendChild(b);
  });
  refGrid();
  const gb=document.getElementById('qb'+idx); if(gb) gb.scrollIntoView({block:'nearest',behavior:'smooth'});
  saveSession();
}
function selOpt(i){ ans[curQ]=i; renderQ(curQ); }
function saveNxt(){ goNxt(); }
function markRev(){ mkd[curQ]=true; goNxt(); }
function clearR(){ ans[curQ]=null; renderQ(curQ); toast('Response cleared'); }
function prevQ(){ if(curQ>0) renderQ(curQ-1); }
function goNxt(){ if(curQ<Q.length-1) renderQ(curQ+1); else toast('You are at the last question!'); }
function startTimer(){
  clearInterval(tInt); showTimer();
  tInt=setInterval(()=>{ tLeft--; showTimer(); if(tLeft%30===0) saveSession(); if(tLeft<=0){ clearInterval(tInt); doSubmit(); } },1000);
}
function showTimer(){
  const h=Math.floor(tLeft/3600),m=Math.floor((tLeft%3600)/60),s=tLeft%60;
  const el=document.getElementById('timer');
  el.textContent=`${p(h)}:${p(m)}:${p(s)}`; el.className='tp-v';
  if(tLeft<=300) el.classList.add('danger'); else if(tLeft<=600) el.classList.add('warn');
}
const p=n=>String(n).padStart(2,'0');
function confirmSub(){
  const a=ans.filter(x=>x!==null).length;
  document.getElementById('md-st').innerHTML=`
    <div class="ms">Total: <span>${Q.length}</span></div><div class="ms">Answered: <span>${a}</span></div>
    <div class="ms">Not Answered: <span>${Q.length-a}</span></div><div class="ms">Marked: <span>${mkd.filter(x=>x).length}</span></div>`;
  document.getElementById('mo').classList.add('on');
}
function closeM(){ document.getElementById('mo').classList.remove('on'); }
async function doSubmit(){
  closeM(); clearInterval(tInt); active=false; clearSess();
  let c=0,w=0,sk=0;
  Q.forEach((q,i)=>{ if(ans[i]===null) sk++; else if(ans[i]===q.correct) c++; else w++; });
  const net=+(c-(negM*w)).toFixed(2), tot=Q.length, pct=Math.max(0,Math.round((net/tot)*100));
  // Save score to Firestore
  try {
    await fbAdd('scores',{name:cName,roll:cRoll,score:net,total:tot,pct,correct:c,wrong:w,skipped:sk,timestamp:new Date().toISOString()});
  } catch(e){ console.warn('Score save failed:',e.message); }
  if(!settings.showResult){ doFresh(); return; }
  document.getElementById('res-cand').textContent=`${cName} | Roll No: ${cRoll}`;
  document.getElementById('res-pct').textContent=pct+'%';
  document.getElementById('res-sc').textContent=`${net} / ${tot}`;
  document.getElementById('res-cor').textContent=c; document.getElementById('res-wr').textContent=w;
  document.getElementById('res-sk').textContent=sk; document.getElementById('sd-c').textContent=c;
  document.getElementById('sd-n').textContent=(negM*w).toFixed(2); document.getElementById('sd-net').textContent=net;
  const msg=pct>=80?'ğŸŒŸ Outstanding!':pct>=60?'ğŸ‘ Good job! Keep practising.':pct>=40?'ğŸ’ª Fair attempt. Study more.':'ğŸ“š Keep going!';
  document.getElementById('res-msg').textContent=msg;
  const circ=376.99,off=circ-(circ*pct/100);
  setTimeout(()=>{ const r=document.getElementById('sr'); r.style.strokeDashoffset=off; r.style.stroke=pct>=60?'var(--gn)':pct>=40?'var(--sf)':'var(--c-no)'; },250);
  showScreen('result');
}
function reviewTest(){
  isRev=true; showScreen('test'); document.getElementById('rv-ban').classList.add('on');
  document.getElementById('timer').textContent='00:00:00';
  document.querySelectorAll('.ab .btn').forEach(b=>{ if(b.getAttribute('onclick')&&['saveNxt','markRev','clearR'].some(f=>b.getAttribute('onclick').includes(f))) b.style.display='none'; });
  renderQ(0);
}
function togSB(){ document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sb-ov').classList.toggle('on'); }
function toggleFS(){ if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else document.exitFullscreen().catch(()=>{}); }
window.addEventListener('beforeunload',e=>{ if(active){ saveSession(); e.preventDefault(); e.returnValue=''; } });
document.addEventListener('keydown',e=>{
  if(!document.getElementById('test').classList.contains('active')||isRev) return;
  if(e.key==='ArrowRight'||e.key==='Enter') saveNxt();
  else if(e.key==='ArrowLeft') prevQ();
  else if(['1','2','3','4'].includes(e.key)) selOpt(+e.key-1);
  else if(e.key==='m'||e.key==='M') markRev();
  else if(e.key==='c'||e.key==='C') clearR();
});
document.addEventListener('visibilitychange',()=>{ if(document.getElementById('test').classList.contains('active')&&!isRev&&document.hidden) toast('âš ï¸ Warning: Do not switch tabs!'); });
document.addEventListener('contextmenu',e=>{ if(document.getElementById('test').classList.contains('active')&&!isRev) e.preventDefault(); });
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]; } return a; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function goAdmin(){
  showScreen('admin-login');
  // Check if first time
  const pwDoc = await fbGet('config/admin');
  if(!pwDoc||!pwDoc.hash){
    document.getElementById('setup-box').style.display='block';
    document.getElementById('al-hint').textContent='No password set yet. Create your admin password:';
    document.getElementById('al-btn').textContent='ğŸ”‘ Create Password & Enter';
  } else {
    document.getElementById('setup-box').style.display='none';
    document.getElementById('al-hint').textContent='Enter your admin password to access the control panel.';
    document.getElementById('al-btn').textContent='ğŸ”“ Login to Admin Panel';
  }
  document.getElementById('al-err').textContent='';
  document.getElementById('al-pw').value='';
  setTimeout(()=>document.getElementById('al-pw').focus(),200);
}
async function doLogin(){
  const pw=document.getElementById('al-pw').value;
  const errEl=document.getElementById('al-err'), btn=document.getElementById('al-btn');
  if(!pw){ errEl.textContent='Please enter a password.'; return; }
  if(pw.length<6){ errEl.textContent='Password must be at least 6 characters.'; return; }
  btn.disabled=true; btn.textContent='Verifyingâ€¦';
  try {
    const hash=await sha256(pw);
    const pwDoc=await fbGet('config/admin');
    if(!pwDoc||!pwDoc.hash){
      // First time â€” save hash to Firestore
      await fbSet('config/admin',{hash, createdAt:new Date().toISOString()});
      adminIn=true; btn.disabled=false;
      toast('âœ… Admin password created!');
      openAdmin();
    } else if(hash===pwDoc.hash){
      adminIn=true; btn.disabled=false;
      openAdmin();
    } else {
      btn.disabled=false; btn.textContent='ğŸ”“ Login to Admin Panel';
      errEl.textContent='âŒ Incorrect password. Try again.';
      document.getElementById('al-pw').value=''; document.getElementById('al-pw').focus();
    }
  } catch(e){ btn.disabled=false; btn.textContent='ğŸ”“ Login'; errEl.textContent='Error: '+e.message; }
}
function toggleEye(){ const i=document.getElementById('al-pw'); i.type=i.type==='password'?'text':'password'; }
async function openAdmin(){
  showScreen('admin-panel');
  await loadAdminData();
}
function adminOut(){ adminIn=false; showScreen('landing'); toast('Logged out.'); }
function reqAdmin(){ if(!adminIn){ showScreen('admin-login'); return false; } return true; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAdminData(){
  if(!reqAdmin()) return;
  // Load questions info
  const qd=await fbGet('config/questions');
  const qs=(qd&&Array.isArray(qd.data))?qd.data:[];
  document.getElementById('ap-nq').textContent=qs.length||'0';
  document.getElementById('qs-n').textContent=qs.length||'0';
  if(qs.length){ const secSet=new Set(qs.map(q=>q.section||'General')); document.getElementById('qs-s').textContent=[...secSet].join(', '); }
  if(qd&&qd.updatedAt){ document.getElementById('lu').classList.add('on'); document.getElementById('lu-t').textContent=fmtDate(qd.updatedAt); }
  // Load scores
  await refreshScores();
  // Load settings
  const s=await fbGet('config/settings'); if(s) Object.assign(settings,s);
  document.getElementById('s-neg').value=settings.negM||0;
  document.getElementById('s-mpq').value=settings.mpq||1;
  if(settings.shuffle) document.getElementById('s-shuf').classList.add('on'); else document.getElementById('s-shuf').classList.remove('on');
  if(settings.showResult!==false) document.getElementById('s-res').classList.add('on'); else document.getElementById('s-res').classList.remove('on');
}

async function refreshScores(){
  try {
    allScores = await fbGetAll('scores');
    document.getElementById('ap-na').textContent=allScores.length;
    if(allScores.length){
      const avg=allScores.reduce((s,r)=>s+(r.pct||0),0)/allScores.length;
      const top=Math.max(...allScores.map(r=>r.pct||0));
      document.getElementById('ap-av').textContent=avg.toFixed(1)+'%';
      document.getElementById('ap-tp').textContent=top+'%';
    } else { document.getElementById('ap-av').textContent='â€”'; document.getElementById('ap-tp').textContent='â€”'; }
    renderTbl();
  } catch(e){ toast('Error loading scores: '+e.message); }
}

function renderTbl(){
  let rows=[...allScores];
  const srch=(document.getElementById('srch')?.value||'').toLowerCase();
  const srt=document.getElementById('srt')?.value||'time';
  if(srch) rows=rows.filter(r=>(r.name||'').toLowerCase().includes(srch)||(r.roll||'').toLowerCase().includes(srch));
  rows.sort((a,b)=>{
    if(srt==='hi') return (b.pct||0)-(a.pct||0);
    if(srt==='lo') return (a.pct||0)-(b.pct||0);
    if(srt==='az') return (a.name||'').localeCompare(b.name||'');
    return (b.ts||0)-(a.ts||0);
  });
  const tbody=document.getElementById('tbl-body');
  if(!rows.length){ tbody.innerHTML=`<tr><td colspan="9" class="tbl-empty">ğŸ“­ No attempts yet.</td></tr>`; return; }
  tbody.innerHTML=rows.map((r,i)=>{
    const cls=r.pct>=60?'sb-hi':r.pct>=40?'sb-md':'sb-lo';
    return `<tr>
      <td style="color:var(--mt);font-size:12px">${i+1}</td>
      <td style="font-weight:600">${esc(r.name||'â€”')}</td>
      <td style="font-size:13px;color:var(--mt)">${esc(r.roll||'â€”')}</td>
      <td><span class="sb ${cls}">${r.score}/${r.total}</span></td>
      <td><b>${r.pct}%</b></td>
      <td style="color:var(--gn);font-weight:700">${r.correct}</td>
      <td style="color:var(--c-no);font-weight:700">${r.wrong}</td>
      <td style="color:var(--mt)">${r.skipped}</td>
      <td style="font-size:12px;color:var(--mt)">${fmtDate(r.timestamp)}</td>
    </tr>`;
  }).join('');
}

async function clearScores(){
  if(!reqAdmin()) return;
  if(!confirm('Delete ALL student score records from Firebase? This cannot be undone.')) return;
  await fbDelAll('scores'); allScores=[];
  document.getElementById('ap-na').textContent='0'; document.getElementById('ap-av').textContent='â€”'; document.getElementById('ap-tp').textContent='â€”';
  renderTbl(); toast('Score records cleared.');
}

async function exportCSV(){
  if(!reqAdmin()||!allScores.length){ toast('No records to export.'); return; }
  const h='Name,Roll,Score,Total,%,Correct,Wrong,Skipped,Timestamp\n';
  const rows=allScores.map(r=>`"${r.name}","${r.roll}",${r.score},${r.total},${r.pct}%,${r.correct},${r.wrong},${r.skipped},"${fmtDate(r.timestamp)}"`).join('\n');
  const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([h+rows],{type:'text/csv'})),download:`nishuabhyasi_scores_${new Date().toISOString().slice(0,10)}.csv`});
  a.click(); toast('CSV exported!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUESTIONS MANAGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function liveValidate(){
  const txt=document.getElementById('q-area').value.trim();
  const msg=document.getElementById('q-msg'), area=document.getElementById('q-area');
  if(!txt){ msg.textContent=''; area.className='q-area'; return false; }
  try {
    const d=JSON.parse(txt);
    if(!Array.isArray(d)||!d.length) throw new Error('Must be a non-empty JSON array');
    const mq=d.filter(q=>!q.q&&!q.question).length;
    const mc=d.filter(q=>q.correct===undefined).length;
    if(mq) throw new Error(`${mq} questions missing "q" field`);
    if(mc) throw new Error(`${mc} questions missing "correct" field`);
    area.className='q-area ok';
    msg.className='q-msg ok';
    const secs=new Set(d.map(q=>q.section||'General'));
    msg.textContent=`âœ… Valid â€” ${d.length} questions across ${secs.size} section(s)`;
    return true;
  } catch(e){ area.className='q-area bad'; msg.className='q-msg bad'; msg.textContent='âŒ '+e.message; return false; }
}
async function saveQ(){
  if(!reqAdmin()||!liveValidate()) return;
  const data=JSON.parse(document.getElementById('q-area').value.trim());
  const now=new Date().toISOString();
  await fbSet('config/questions',{data,updatedAt:now});
  Q=settings.shuffle?shuffle([...data]):data;
  updateLanding();
  document.getElementById('ap-nq').textContent=data.length;
  document.getElementById('qs-n').textContent=data.length;
  const secs=new Set(data.map(q=>q.section||'General'));
  document.getElementById('qs-s').textContent=[...secs].join(', ');
  document.getElementById('lu').classList.add('on');
  document.getElementById('lu-t').textContent=fmtDate(now);
  toast(`âœ… ${data.length} questions saved to Firebase & published!`);
}
async function loadQ(){
  if(!reqAdmin()) return;
  const qd=await fbGet('config/questions');
  if(!qd||!qd.data||!qd.data.length){ toast('No questions in Firebase yet.'); return; }
  document.getElementById('q-area').value=JSON.stringify(qd.data,null,2);
  liveValidate(); toast(`Loaded ${qd.data.length} questions from Firebase.`);
}
async function clearQ(){
  if(!reqAdmin()) return;
  if(!confirm('Clear ALL questions from Firebase? Students cannot take tests until new questions are added.')) return;
  await fbSet('config/questions',{data:[],updatedAt:new Date().toISOString()});
  Q=[]; updateLanding();
  document.getElementById('q-area').value=''; document.getElementById('q-msg').textContent='';
  document.getElementById('q-area').className='q-area';
  document.getElementById('ap-nq').textContent='0'; document.getElementById('qs-n').textContent='0';
  document.getElementById('qs-s').textContent='â€”'; document.getElementById('lu').classList.remove('on');
  toast('Questions cleared from Firebase.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togSet(id){ document.getElementById(id).classList.toggle('on'); }
async function saveSettings(){
  if(!reqAdmin()) return;
  settings.negM=parseFloat(document.getElementById('s-neg').value)||0;
  settings.mpq=parseFloat(document.getElementById('s-mpq').value)||1;
  settings.shuffle=document.getElementById('s-shuf').classList.contains('on');
  settings.showResult=document.getElementById('s-res').classList.contains('on');
  await fbSet('config/settings',settings);
  negM=settings.negM; updateLanding();
  toast('âœ… Settings saved to Firebase!');
}
async function changePw(){
  if(!reqAdmin()) return;
  const np=document.getElementById('s-npw').value.trim();
  if(!np||np.length<6){ toast('Password must be at least 6 characters.'); return; }
  const hash=await sha256(np);
  await fbSet('config/admin',{hash,updatedAt:new Date().toISOString()});
  document.getElementById('s-npw').value='';
  toast('âœ… Admin password updated in Firebase!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtDate(iso){ try{ const d=new Date(iso); return d.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'})+' '+d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true}); }catch(e){ return iso; } }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
let _tt;
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('on'); clearTimeout(_tt); _tt=setTimeout(()=>t.classList.remove('on'),2800); }
</script>
</body>
</html>
